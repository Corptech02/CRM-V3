<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Sync Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d1fae5; border: 1px solid #10b981; }
        .error { background: #fee2e2; border: 1px solid #ef4444; }
        .info { background: #dbeafe; border: 1px solid #3b82f6; }
        button { margin: 5px; padding: 10px 15px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Verify Sync Flow</h1>

    <button onclick="checkDatabaseVsLocalStorage()">Check Database vs localStorage</button>
    <button onclick="testSyncButton()">Test Sync Button Flow</button>
    <button onclick="clearResults()">Clear Results</button>

    <div id="results"></div>

    <script>
        async function checkDatabaseVsLocalStorage() {
            addResult('üîç Comparing Database vs localStorage...', 'info');

            try {
                // Check database
                const dbResponse = await fetch('/api/leads');
                const dbLeads = dbResponse.ok ? await dbResponse.json() : [];

                // Check localStorage
                const localLeads = JSON.parse(localStorage.getItem('insurance_leads') || '[]');

                addResult(`üìä Database: ${dbLeads.length} leads`, 'info');
                addResult(`üíæ localStorage: ${localLeads.length} leads`, 'info');

                // Check for enhanced fields in both
                const dbEnhanced = dbLeads.filter(l => l.currentInsuranceCompany || l.audioUrl);
                const localEnhanced = localLeads.filter(l => l.currentInsuranceCompany || l.audioUrl);

                addResult(`üöÄ Database Enhanced: ${dbEnhanced.length} leads with enhanced data`,
                         dbEnhanced.length > 0 ? 'success' : 'error');
                addResult(`üöÄ localStorage Enhanced: ${localEnhanced.length} leads with enhanced data`,
                         localEnhanced.length > 0 ? 'success' : 'error');

                // Show examples
                if (dbEnhanced.length > 0) {
                    const example = dbEnhanced[0];
                    addResult(`üìã DB Example: ${example.name} - Insurance: ${example.currentInsuranceCompany || 'None'} - Audio: ${example.audioFileName || 'None'}`, 'info');
                }

                if (localEnhanced.length > 0) {
                    const example = localEnhanced[0];
                    addResult(`üìã Local Example: ${example.name} - Insurance: ${example.currentInsuranceCompany || 'None'} - Audio: ${example.audioFileName || 'None'}`, 'info');
                }

                // Sync recommendation
                if (dbEnhanced.length > localEnhanced.length) {
                    addResult('‚ö†Ô∏è Database has more enhanced data than localStorage - Need to sync!', 'error');

                    // Auto-sync
                    localStorage.setItem('insurance_leads', JSON.stringify(dbLeads));
                    addResult('‚úÖ Auto-synced database leads to localStorage', 'success');
                }

            } catch (error) {
                addResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testSyncButton() {
            addResult('üîÑ Testing Sync Button Flow...', 'info');

            try {
                // Check if the sync function exists
                if (typeof window.syncVicidialLeads === 'function') {
                    addResult('‚úÖ window.syncVicidialLeads function found', 'success');

                    // You could call it here, but it opens a modal
                    addResult('‚ÑπÔ∏è Sync function available (opens modal when called)', 'info');

                    // Instead, directly test the API endpoint
                    const response = await fetch('/api/vicidial/sync-with-premium', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ selectedLeads: [] })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        addResult(`‚úÖ Sync API works: ${result.message || 'Success'}`, 'success');

                        // Wait a moment then refresh data
                        setTimeout(async () => {
                            await checkDatabaseVsLocalStorage();
                        }, 1000);
                    } else {
                        addResult(`‚ùå Sync API failed: ${response.status}`, 'error');
                    }
                } else {
                    addResult('‚ùå window.syncVicidialLeads function not found!', 'error');
                }
            } catch (error) {
                addResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function addResult(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        // Auto-run initial check
        window.addEventListener('load', function() {
            addResult('üöÄ Verification page loaded', 'info');
            setTimeout(checkDatabaseVsLocalStorage, 500);
        });
    </script>
</body>
</html>