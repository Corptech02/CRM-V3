<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Cache buster: 2025-01-13-VICIDIAL-BUTTON-FIX -->
    <title>Vanguard Insurance Software - All-in-One Agency Management Platform</title>
    <link rel="icon" type="image/png" href="images/V-Logo.png">
    <link rel="stylesheet" href="css/styles.css?v=35">
    <link rel="stylesheet" href="css/carrier-profile.css?v=2">
    <link rel="stylesheet" href="css/policy-modal.css?v=3">
    <link rel="stylesheet" href="css/coi-upload-styles.css?v=1">
    <link rel="stylesheet" href="css/mobile.css?v=5">
    <link rel="stylesheet" href="css/fix-sidebar-text.css?v=1">
    <!-- Enhanced Lead Management Action Button Fixes -->
    <link rel="stylesheet" href="css/enhanced-lead-actions.css?v=1">
    <!-- Sticky Table Header -->
    <link rel="stylesheet" href="css/sticky-table-header.css?v=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Dancing+Script:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="pdf.min.js"></script>
    <!-- Critical Performance Fix - MUST LOAD FIRST -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <!-- HTML2Canvas for screenshot functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SIP calling library for VoIP functionality -->
    <script src="js/jssip.min.js"></script>
    <!-- Twilio Voice SDK for browser-based calling -->
    <script src="https://sdk.twilio.com/js/voice/releases/2.12.0/twilio.min.js"></script>
    <script src="js/performance-critical-fix.js?v=1"></script>
    <script src="js/fix-localStorage-quota.js?v=1"></script>
    <script src="js/disable-heavy-scripts.js?v=1"></script>
    <script>
        // Check authentication first
        if (!sessionStorage.getItem('vanguard_user')) {
            window.location.href = '/login.html';
        }

        // Set up PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';
        }
    </script>
    <!-- COI Email Timeout Fix -->
    <script src="js/fix-coi-email-timeout.js?v=999"></script>

    <!-- COI Policy Lookup Fix -->
    <script src="js/fix-coi-policy-lookup.js?v=1"></script>

    <!-- Call Status Fix -->
    <script src="js/call-status-fix.js?v=1"></script>
    <script src="js/simple-call-fix.js?v=1"></script>
    <script src="js/incoming-calls.js?v=15"></script>
    <script src="js/simple-pickup.js?v=2"></script>
    <script src="js/twilio-voice-softphone.js?v=1"></script>
    <script src="js/sse-debug.js?v=1"></script>
    <script src="js/fix-call-disconnect-detection.js?v=1"></script>

    <!-- HEAD TEST DISABLED - Using comprehensive script only -->
    <style>
        /* Red styling for high-call, low-talk-time leads */

        /* Force lead name truncation and contact icon display */
        #leadsTableBody .lead-name {
            max-width: 150px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        #leadsTableBody .lead-name strong {
            display: block !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            max-width: 150px !important;
        }

        #leadsTableBody .contact-info {
            display: flex !important;
            gap: 12px !important;
            align-items: center !important;
            justify-content: center !important;
            min-width: 70px !important;
            max-width: 80px !important;
        }

        #leadsTableBody .contact-info div {
            display: none !important;
        }

        #leadsTableBody .contact-info a {
            display: inline-flex !important;
            width: 28px !important;
            height: 28px !important;
            align-items: center !important;
            justify-content: center !important;
            background: #e6f2ff !important;
            border-radius: 50% !important;
            color: #0066cc !important;
            text-decoration: none !important;
        }

        #leadsTableBody .contact-info a:hover {
            background: #0066cc !important;
            color: white !important;
        }

        /* Optimize table with uniform spacing */
        #leadsTable {
            width: 100% !important;
            table-layout: fixed !important;
        }

        #leadsTable th,
        #leadsTable td {
            padding: 10px 12px !important;
            text-align: left !important;
        }

        /* Checkbox column */
        #leadsTable th:nth-child(1),
        #leadsTable td:nth-child(1) {
            width: 40px !important;
            text-align: center !important;
        }

        /* Name column */
        #leadsTable th:nth-child(2),
        #leadsTable td:nth-child(2) {
            width: 140px !important;
            max-width: 140px !important;
        }

        /* Contact column - centered icons */
        #leadsTable th:nth-child(3),
        #leadsTable td:nth-child(3) {
            width: 80px !important;
            text-align: center !important;
        }

        /* Value Level */
        #leadsTable th:nth-child(4),
        #leadsTable td:nth-child(4) {
            width: 160px !important;
        }

        /* Premium */
        #leadsTable th:nth-child(5),
        #leadsTable td:nth-child(5) {
            width: 90px !important;
        }

        /* Stage */
        #leadsTable th:nth-child(6),
        #leadsTable td:nth-child(6) {
            width: 100px !important;
        }

        /* To Do - NEW COLUMN that was missing */
        #leadsTable th:nth-child(7),
        #leadsTable td:nth-child(7) {
            width: 130px !important;
            max-width: 130px !important;
        }

        /* Renewal Date - needs more space for header + sort arrow */
        #leadsTable th:nth-child(8),
        #leadsTable td:nth-child(8) {
            width: 110px !important;
        }

        #leadsTable th:nth-child(8) {
            white-space: nowrap !important;
            overflow: hidden !important;
        }

        /* Assigned To */
        #leadsTable th:nth-child(9),
        #leadsTable td:nth-child(9) {
            width: 100px !important;
        }

        /* Created */
        #leadsTable th:nth-child(10),
        #leadsTable td:nth-child(10) {
            width: 90px !important;
        }

        /* Actions */
        #leadsTable th:nth-child(11),
        #leadsTable td:nth-child(11) {
            width: 110px !important;
            min-width: 110px !important;
            text-align: center !important;
        }

        /* Action buttons - ensure horizontal alignment */
        #leadsTable .action-buttons {
            display: flex !important;
            justify-content: center !important;
            gap: 8px !important;
            flex-wrap: nowrap !important;
        }

        #leadsTable .btn-icon {
            padding: 6px 8px !important;
            margin: 0 !important;
            font-size: 12px !important;
            flex-shrink: 0 !important;
        }

        /* Fix sort arrows to prevent overflow */
        #leadsTable th.sortable {
            position: relative !important;
            padding-right: 25px !important;
        }

        #leadsTable th.sortable .sort-arrow {
            position: absolute !important;
            right: 8px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
        }

        /* Ensure Value Level text doesn't wrap unnecessarily */
        #leadsTableBody td:nth-child(4) {
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* Policy Management Table Spacing */
        #policyTableBody td,
        .policies-view .data-table td {
            padding: 12px 15px !important;
            white-space: nowrap !important;
        }

        .policies-view .data-table th {
            padding: 12px 15px !important;
            text-align: left !important;
            font-weight: 600 !important;
            white-space: nowrap !important;
        }

        /* Ensure proper spacing for policy table columns */
        .policies-view .data-table {
            table-layout: fixed !important;
            width: 100% !important;
        }

        /* Policy number column */
        .policies-view .data-table td.policy-number {
            font-weight: 500 !important;
            color: #3b82f6 !important;
        }

        /* Force hide Type and Status columns in Clients Management */
        .clients-view .data-table th:nth-child(4):contains("Type"),
        .clients-view .data-table th:nth-child(5):contains("Status"),
        .clients-view .data-table td:nth-child(4).client-type,
        .clients-view .data-table td:nth-child(5).client-status {
            display: none !important;
        }

        /* Ensure clients table has correct column count */
        .clients-view .data-table thead tr th {
            padding: 12px 15px !important;
        }

        .clients-view .data-table {
            table-layout: auto !important;
        }

        /* BULLETPROOF HIGHLIGHTING CSS - Maximum specificity to override everything */
        #leadsTableBody tr.force-persistent-highlight[data-highlight="yellow"],
        #leadsTableBody tr[data-highlight="yellow"],
        #leadsTableBody tr.timestamp-yellow,
        table tr[data-highlight="yellow"] {
            background-color: #fef3c7 !important;
            background: #fef3c7 !important;
            border-left: 4px solid #f59e0b !important;
            border-right: 2px solid #f59e0b !important;
        }

        #leadsTableBody tr.force-persistent-highlight[data-highlight="orange"],
        #leadsTableBody tr[data-highlight="orange"],
        #leadsTableBody tr.timestamp-orange,
        table tr[data-highlight="orange"] {
            background-color: #fed7aa !important;
            background: #fed7aa !important;
            border-left: 4px solid #fb923c !important;
            border-right: 2px solid #fb923c !important;
        }

        #leadsTableBody tr.force-persistent-highlight[data-highlight="red"],
        #leadsTableBody tr[data-highlight="red"],
        #leadsTableBody tr.timestamp-red,
        table tr[data-highlight="red"] {
            background-color: #fecaca !important;
            background: #fecaca !important;
            border-left: 4px solid #ef4444 !important;
            border-right: 2px solid #ef4444 !important;
        }

        /* GREY highlighting for process complete */
        #leadsTableBody tr.process-complete,
        table tr.process-complete {
            background-color: rgba(156, 163, 175, 0.3) !important;
            background: rgba(156, 163, 175, 0.3) !important;
            border-left: 4px solid #9ca3af !important;
            border-right: 2px solid #9ca3af !important;
        }

        /* GREEN highlighting for reach out complete (empty TODO) */
        #leadsTableBody tr.reach-out-complete,
        table tr.reach-out-complete {
            background-color: rgba(16, 185, 129, 0.2) !important;
            background: rgba(16, 185, 129, 0.2) !important;
            border-left: 4px solid #10b981 !important;
            border-right: 2px solid #10b981 !important;
        }

        /* Force transparent cells for highlighted rows */
        #leadsTableBody tr[data-highlight-applied="true"] td,
        #leadsTableBody tr[data-highlight] td,
        #leadsTableBody tr.timestamp-yellow td,
        #leadsTableBody tr.timestamp-orange td,
        #leadsTableBody tr.timestamp-red td,
        #leadsTableBody tr.process-complete td,
        #leadsTableBody tr.reach-out-complete td {
            background-color: transparent !important;
            background: transparent !important;
        }

        /* Ultimate specificity - use CSS variables that can't be overridden */
        :root {
            --yellow-bg: #fef3c7;
            --yellow-border: #f59e0b;
            --orange-bg: #fed7aa;
            --orange-border: #fb923c;
            --red-bg: #fecaca;
            --red-border: #ef4444;
            --green-bg: rgba(16, 185, 129, 0.2);
            --green-border: #10b981;
        }

        /* Apply via CSS custom properties */
        tr[data-highlight="yellow"],
        tr.timestamp-yellow {
            background-color: var(--yellow-bg) !important;
            border-left: 4px solid var(--yellow-border) !important;
        }

        tr[data-highlight="orange"],
        tr.timestamp-orange {
            background-color: var(--orange-bg) !important;
            border-left: 4px solid var(--orange-border) !important;
        }

        tr[data-highlight="red"],
        tr.timestamp-red {
            background-color: var(--red-bg) !important;
            border-left: 4px solid var(--red-border) !important;
        }

        /* NUCLEAR HIGHLIGHTING - Absolutely bulletproof */
        tr.nuclear-highlight.timestamp-yellow,
        tr[data-nuclear-highlight="yellow"] {
            background-color: #fef3c7 !important;
            background: #fef3c7 !important;
            border-left: 4px solid #f59e0b !important;
            border-right: 2px solid #f59e0b !important;
        }

        tr.nuclear-highlight.timestamp-orange,
        tr[data-nuclear-highlight="orange"] {
            background-color: #fed7aa !important;
            background: #fed7aa !important;
            border-left: 4px solid #fb923c !important;
            border-right: 2px solid #fb923c !important;
        }

        tr.nuclear-highlight.timestamp-red,
        tr[data-nuclear-highlight="red"] {
            background-color: #fecaca !important;
            background: #fecaca !important;
            border-left: 4px solid #ef4444 !important;
            border-right: 2px solid #ef4444 !important;
        }

        tr.nuclear-highlight.process-complete,
        tr[data-nuclear-highlight="grey"] {
            background-color: rgba(156, 163, 175, 0.3) !important;
            background: rgba(156, 163, 175, 0.3) !important;
            border-left: 4px solid #9ca3af !important;
            border-right: 2px solid #9ca3af !important;
        }

        tr.nuclear-highlight.reach-out-complete,
        tr[data-nuclear-highlight="green"] {
            background-color: rgba(16, 185, 129, 0.2) !important;
            background: rgba(16, 185, 129, 0.2) !important;
            border-left: 4px solid #10b981 !important;
            border-right: 2px solid #10b981 !important;
        }


        /* Force transparent cells for nuclear highlighted rows */
        tr[data-nuclear-applied="true"] td,
        tr.nuclear-highlight td {
            background-color: transparent !important;
            background: transparent !important;
        }

        /* TODO Text Coloring */
        #leadsTable td:nth-child(7) strong {
            font-weight: bold !important;
        }

        /* Green color for "Process complete" TODO text */
        #leadsTable td:nth-child(7) strong.todo-process-complete,
        #leadsTableBody td:nth-child(7) strong.todo-process-complete {
            color: #059669 !important; /* Green-600 */
            font-weight: bold !important;
        }

        /* Red color for "Reach out to lead" TODO text */
        #leadsTable td:nth-child(7) strong.todo-reach-out,
        #leadsTableBody td:nth-child(7) strong.todo-reach-out {
            color: #dc2626 !important; /* Red-600 */
            font-weight: bold !important;
        }

        /* GREEN COLOR FOR HIGH VALUE LEADS STAT WHEN >= 10 */
        .stat-number.high-value-achieved {
            color: #16a34a !important;
            font-weight: bold !important;
        }

        /* GOLD BORDER FOR 60+ MINUTE LEADS - SINGLE CONSISTENT OUTLINE */
        tr.gold-border-lead {
            /* Remove any existing borders */
            border-left: none !important;
            border-right: none !important;
            border-bottom: none !important;
            border-top: none !important;
            border: none !important;

            /* Single consistent gold outline */
            outline: 6px solid #f59e0b !important;
            outline-offset: -6px !important;
            box-shadow: 0 0 16px rgba(245, 158, 11, 0.8) !important;
            position: relative !important;
            z-index: 999 !important;
        }

        /* ENHANCED: Ensure gold border shows with green highlighting but no double borders */
        tr.gold-border-lead.reach-out-complete {
            /* Keep green background but remove green borders */
            background-color: rgba(16, 185, 129, 0.2) !important;
            border-left: none !important;
            border-right: none !important;
            border-bottom: none !important;
            border-top: none !important;
            border: none !important;

            /* Same single gold outline */
            outline: 6px solid #f59e0b !important;
            outline-offset: -6px !important;
            box-shadow: 0 0 16px rgba(245, 158, 11, 0.8) !important;
            z-index: 1000 !important;
        }

        /* HIGHEST PRIORITY: Force single gold border over any inline styles */
        tr.gold-border-lead[style] {
            border-left: none !important;
            border-right: none !important;
            border-bottom: none !important;
            border-top: none !important;
            border: none !important;
            /* Same consistent single gold outline */
            outline: 6px solid #f59e0b !important;
            outline-offset: -6px !important;
            box-shadow: 0 0 16px rgba(245, 158, 11, 0.8) !important;
        }
    </style>
    <!-- Authentication Service -->
    <script src="js/auth-service.js"></script>
    <!-- EMERGENCY FIX: Force ViciDial Leads Persistence -->
    <script src="js/force-vicidial-leads.js?v=1"></script>
    <!-- API Configuration - MUST LOAD FIRST -->
    <script src="js/api-config.js?v=2"></script>
    <!-- API Integration Layer -->
    <!-- <script src="js/api-integration.js?v=1"></script> DISABLED - Overriding loadLeadsView -->
    <!-- Policy API Integration -->
    <script src="js/policy-api-integration.js?v=1"></script>
    <!-- Reminders API Integration -->
    <script src="js/reminders-api-integration.js?v=1"></script>
    <!-- API Integration Test Suite - DISABLED to remove popup -->
    <!-- <script src="js/api-integration-test.js?v=1"></script> -->
    <!-- API Configuration Validator - DISABLED to remove popup -->
    <!-- <script src="js/api-config-validator.js?v=1"></script> -->

    <!-- Preserve ORIGINAL stage display (don't override) -->
    <script src="js/preserve-original-stages.js?v=1"></script>
</head>
<body>

    <!-- SIP Phone functionality -->
    <script>
        function toggleSipPhone() {
            // Show the Twilio Voice WebRTC softphone widget
            if (typeof toggleTwilioVoicePhone === 'function') {
                toggleTwilioVoicePhone();
            } else {
                console.log('ðŸ”„ Twilio Voice phone not ready, trying to initialize...');
                setTimeout(() => {
                    if (typeof toggleTwilioVoicePhone === 'function') {
                        toggleTwilioVoicePhone();
                    } else {
                        alert('Twilio Voice phone is loading, please try again in a moment.');
                    }
                }, 2000);
            }
        }

        function launchWebRTCSoftphone() {
            const url = '/js/ctx-softphone/index.html';
            const features = 'menubar=no,location=no,resizable=no,scrollbars=no,status=no,addressbar=no,width=320,height=480,top=100,left=100';

            // Check if phone is already open
            if (!localStorage.getItem('ctxPhone')) {
                const phoneWindow = window.open(url, 'ctxPhone', features);
                console.log('ðŸ“ž WebRTC Softphone launched');

                // Set flag to prevent multiple instances
                localStorage.setItem('ctxPhone', 'open');

                // Clean up flag when window closes (modern browsers)
                if (phoneWindow) {
                    const checkClosed = setInterval(() => {
                        if (phoneWindow.closed) {
                            localStorage.removeItem('ctxPhone');
                            clearInterval(checkClosed);
                            console.log('ðŸ“ž Softphone closed');
                        }
                    }, 1000);
                }

            } else {
                alert('ðŸ“ž WebRTC Softphone is already open');
            }
        }

        // Global function for easy calling
        window.launchWebRTCSoftphone = launchWebRTCSoftphone;

        console.log('âœ… DIRECT HTML: SIP Phone button loaded successfully');
    </script>

    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <img src="images/V-Logo.png" alt="Vanguard Insurance Group" class="logo">
                    <div class="brand-text">
                        <h1>Vanguard Software</h1>
                        <span>Agency Management Platform</span>
                    </div>
                </div>
                <ul class="nav-menu">
                    <li><a href="#dashboard" class="nav-link active">Dashboard</a></li>
                    <li class="dropdown">
                        <a href="#" class="nav-link">Tools <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-menu">
                            <a href="#" onclick="openPhoneTool(); return false;"><i class="fas fa-phone"></i> Phone</a>
                            <a href="#" onclick="openEmailTool(); return false;"><i class="fas fa-envelope"></i> Email</a>
                            <a href="#" onclick="openNotepad(); return false;"><i class="fas fa-sticky-note"></i> Notepad</a>
                        </div>
                    </li>
                    <li><a href="#analytics" class="nav-link">Analytics</a></li>
                    <li><a href="#integrations" class="nav-link">Integrations</a></li>
                </ul>
                <div class="nav-actions">
                    <button class="notification-btn">
                        <i class="fas fa-bell"></i>
                    </button>
                    <div class="user-menu" id="userMenuNav" onclick="toggleUserMenu()" style="cursor: pointer;">
                        <img src="https://ui-avatars.com/api/?name=User&background=0066cc&color=fff" alt="User" class="user-avatar" id="userAvatar">
                        <span id="userNameDisplay">User</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <!-- Mobile Menu Toggle -->
                    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                    <div id="userDropdown" style="display: none; position: absolute; top: 60px; right: 20px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 180px;">
                        <a href="#" onclick="logout(); return false;" style="display: block; padding: 12px 16px; color: #374151; text-decoration: none; hover: background: #f3f4f6; border-radius: 8px;">
                            <i class="fas fa-sign-out-alt" style="margin-right: 8px; color: #6b7280;"></i>
                            Logout
                        </a>
                    </div>
                </div>
                <script>
                    function toggleUserMenu() {
                        const dropdown = document.getElementById('userDropdown');
                        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                    }

                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('#userMenuNav') && !e.target.closest('#userDropdown')) {
                            document.getElementById('userDropdown').style.display = 'none';
                        }
                    });

                    // Update user display
                    const updateUserDisplay = () => {
                        const userData = sessionStorage.getItem('vanguard_user');
                        if (userData) {
                            const user = JSON.parse(userData);
                            const nameDisplay = document.getElementById('userNameDisplay');
                            const avatar = document.getElementById('userAvatar');

                            if (nameDisplay) {
                                // Check if user is admin
                                const isAdmin = (username) => {
                                    const adminUsers = ['grant', 'maureen'];
                                    return adminUsers.includes(username.toLowerCase());
                                };

                                // Create admin badge if user is admin
                                const adminBadge = isAdmin(user.username) ? `
                                    <span style="
                                        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
                                        color: white;
                                        padding: 2px 6px;
                                        border-radius: 10px;
                                        font-size: 10px;
                                        font-weight: 600;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        margin-left: 6px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                        border: 1px solid rgba(255,255,255,0.3);
                                    ">
                                        <i class="fas fa-crown" style="margin-right: 3px; font-size: 9px;"></i>ADMIN
                                    </span>
                                ` : '';

                                nameDisplay.innerHTML = user.username + adminBadge;
                            }
                            if (avatar) avatar.src = `https://ui-avatars.com/api/?name=${user.username}&background=0066cc&color=fff`;

                            // Control admin UI sections based on user role
                            controlAdminUI(user.username);
                        }
                    };

                    // Control admin UI visibility based on user role
                    const controlAdminUI = (username) => {
                        console.log('controlAdminUI called with username:', username);

                        const isAdmin = (username) => {
                            const adminUsers = ['grant', 'maureen'];
                            const isAdminUser = adminUsers.includes(username.toLowerCase());
                            console.log('Checking admin status for:', username, '-> isAdmin:', isAdminUser);
                            return isAdminUser;
                        };

                        const applyAdminControls = () => {
                            console.log('Applying admin controls...');

                            // Find Administration section in sidebar
                            const menuSections = document.querySelectorAll('.sidebar-menu .menu-section');
                            console.log('Found menu sections:', menuSections.length);

                            let administrationSectionFound = false;

                            menuSections.forEach((section, index) => {
                                const heading = section.querySelector('h3');
                                if (heading) {
                                    console.log(`Section ${index} heading:`, heading.textContent.trim());

                                    if (heading.textContent.trim() === 'Administration') {
                                        administrationSectionFound = true;
                                        console.log('Found Administration section!');

                                        if (isAdmin(username)) {
                                            section.style.display = 'block';
                                            section.style.visibility = 'visible';
                                            console.log('âœ… Admin user - Administration section visible');
                                        } else {
                                            section.style.display = 'none';
                                            section.style.visibility = 'hidden';
                                            console.log('âŒ Non-admin user - Administration section hidden');
                                        }
                                    }
                                }
                            });

                            if (!administrationSectionFound) {
                                console.warn('âš ï¸ Administration section not found in sidebar!');
                            }

                            // Hide dashboard stats for non-admin users
                            const adminOnlyStats = [
                                'Active Clients',
                                'Active Policies',
                                'All Time Premium',
                                'Monthly Lead Premium'
                            ];

                            const statCards = document.querySelectorAll('.stat-card');
                            console.log('Found stat cards:', statCards.length);

                            statCards.forEach((card, index) => {
                                const statTitle = card.querySelector('.stat-details h3');
                                if (statTitle) {
                                    const titleText = statTitle.textContent.trim();
                                    console.log(`Stat card ${index} title:`, titleText);

                                    if (adminOnlyStats.includes(titleText)) {
                                        if (isAdmin(username)) {
                                            card.style.display = 'block';
                                            card.style.visibility = 'visible';
                                            console.log(`âœ… Admin - Showing stat: ${titleText}`);
                                        } else {
                                            card.style.display = 'none';
                                            card.style.visibility = 'hidden';
                                            console.log(`âŒ Non-admin - Hiding stat: ${titleText}`);
                                        }
                                    }
                                }
                            });
                        };

                        // Apply controls with multiple attempts
                        setTimeout(applyAdminControls, 100);
                        setTimeout(applyAdminControls, 500);
                        setTimeout(applyAdminControls, 1000);

                        // Also apply when DOM is ready
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', applyAdminControls);
                        } else {
                            applyAdminControls();
                        }

                        // Set up MutationObserver to watch for content changes (like dashboard reloads)
                        const adminControlObserver = new MutationObserver((mutations) => {
                            let shouldReapply = false;

                            mutations.forEach((mutation) => {
                                // Check if stat cards or sidebar sections were added/modified
                                if (mutation.type === 'childList') {
                                    const addedNodes = Array.from(mutation.addedNodes);
                                    const hasStatCard = addedNodes.some(node =>
                                        node.nodeType === 1 && (
                                            node.classList?.contains('stat-card') ||
                                            node.querySelector?.('.stat-card') ||
                                            node.classList?.contains('menu-section') ||
                                            node.querySelector?.('.menu-section')
                                        )
                                    );

                                    if (hasStatCard) {
                                        shouldReapply = true;
                                        console.log('Content reload detected, reapplying admin controls...');
                                    }
                                }
                            });

                            if (shouldReapply) {
                                // Small delay to ensure content is fully loaded
                                setTimeout(applyAdminControls, 100);
                            }
                        });

                        // Start observing
                        adminControlObserver.observe(document.body, {
                            childList: true,
                            subtree: true
                        });

                        console.log('Admin control observer set up to watch for content changes');
                    };

                    // Update on load
                    updateUserDisplay();
                    // Update after DOM ready
                    document.addEventListener('DOMContentLoaded', updateUserDisplay);
                </script>
            </div>
        </nav>
    </header>

    <!-- Mobile Navigation Menu -->
    <nav class="mobile-nav" id="mobileNav">
        <ul class="mobile-nav-list">
            <!-- Main Section -->
            <li class="mobile-nav-section-header">
                <span>Main</span>
            </li>
            <li class="mobile-nav-item">
                <a href="#dashboard" class="mobile-nav-link" onclick="setActiveTab('dashboard'); closeMobileMenu();">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#leads" class="mobile-nav-link" onclick="setActiveTab('leads'); closeMobileMenu();">
                    <i class="fas fa-users"></i>
                    Leads
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#clients" class="mobile-nav-link" onclick="setActiveTab('clients'); closeMobileMenu();">
                    <i class="fas fa-user-tie"></i>
                    Clients
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#policies" class="mobile-nav-link" onclick="setActiveTab('policies'); closeMobileMenu();">
                    <i class="fas fa-file-contract"></i>
                    Policies
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#renewals" class="mobile-nav-link" onclick="setActiveTab('renewals'); closeMobileMenu();">
                    <i class="fas fa-redo"></i>
                    Renewals
                </a>
            </li>

            <!-- Tools Section -->
            <li class="mobile-nav-section-header">
                <span>Tools</span>
            </li>
            <li class="mobile-nav-item">
                <a href="#lead-gen" class="mobile-nav-link" onclick="setActiveTab('lead-gen'); closeMobileMenu();">
                    <i class="fas fa-bullseye"></i>
                    Lead Gen
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#coi-management" class="mobile-nav-link" onclick="setActiveTab('coi-management'); closeMobileMenu();">
                    <i class="fas fa-certificate"></i>
                    COI Management
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#communications" class="mobile-nav-link" onclick="setActiveTab('communications'); closeMobileMenu();">
                    <i class="fas fa-comments"></i>
                    Communications
                </a>
            </li>

            <!-- Admin Section -->
            <li class="mobile-nav-section-header">
                <span>Admin</span>
            </li>
            <li class="mobile-nav-item">
                <a href="#carriers" class="mobile-nav-link" onclick="setActiveTab('carriers'); closeMobileMenu();">
                    <i class="fas fa-truck"></i>
                    Carriers
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#producers" class="mobile-nav-link" onclick="setActiveTab('producers'); closeMobileMenu();">
                    <i class="fas fa-user-friends"></i>
                    Producers
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#accounting" class="mobile-nav-link" onclick="setActiveTab('accounting'); closeMobileMenu();">
                    <i class="fas fa-calculator"></i>
                    Accounting
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="#reports" class="mobile-nav-link" onclick="setActiveTab('reports'); closeMobileMenu();">
                    <i class="fas fa-chart-bar"></i>
                    Reports
                </a>
            </li>

            <!-- Logout -->
            <li class="mobile-nav-divider"></li>
            <li class="mobile-nav-item">
                <a href="#" class="mobile-nav-link" onclick="logout(); closeMobileMenu();">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </li>
        </ul>
    </nav>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

    <!-- Main Dashboard -->
    <main class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-menu">
                <div class="menu-section">
                    <h3>Main</h3>
                    <ul>
                        <li class="active">
                            <a href="#dashboard" data-tooltip="Dashboard">
                                <i class="fas fa-home"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="#leads" data-tooltip="Leads">
                                <i class="fas fa-user-plus"></i>
                                <span>Leads</span>
                            </a>
                        </li>
                        <li>
                            <a href="#clients" data-tooltip="Clients">
                                <i class="fas fa-users"></i>
                                <span>Clients</span>
                            </a>
                        </li>
                        <li>
                            <a href="#policies" data-tooltip="Policies">
                                <i class="fas fa-file-contract"></i>
                                <span>Policies</span>
                            </a>
                        </li>
                        <li>
                            <a href="#renewals" data-tooltip="Renewals">
                                <i class="fas fa-sync-alt"></i>
                                <span>Renewals</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="menu-section">
                    <h3>Tools</h3>
                    <ul>
                        <li>
                            <a href="#lead-generation" data-tooltip="Lead Generation">
                                <i class="fas fa-search-location"></i>
                                <span>Lead Generation</span>
                            </a>
                        </li>
                        <li>
                            <a href="#coi" data-tooltip="COI Management">
                                <i class="fas fa-certificate"></i>
                                <span>COI Management</span>
                            </a>
                        </li>
                        <li>
                            <a href="#communications" data-tooltip="Communications">
                                <i class="fas fa-envelope"></i>
                                <span>Communications</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="menu-section">
                    <h3>Administration</h3>
                    <ul>
                        <li>
                            <a href="#carriers" data-tooltip="Carriers">
                                <i class="fas fa-building"></i>
                                <span>Carriers</span>
                            </a>
                        </li>
                        <li>
                            <a href="#producers" data-tooltip="Producers">
                                <i class="fas fa-user-tie"></i>
                                <span>Producers</span>
                            </a>
                        </li>
                        <li>
                            <a href="#accounting" data-tooltip="Accounting">
                                <i class="fas fa-dollar-sign"></i>
                                <span>Accounting</span>
                            </a>
                        </li>
                        <li>
                            <a href="#reports" data-tooltip="Reports">
                                <i class="fas fa-chart-bar"></i>
                                <span>Reports</span>
                            </a>
                        </li>
                        <li>
                            <a href="#settings" data-tooltip="Settings">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Dashboard Content -->
        <section class="dashboard-content">
            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-details">
                        <h3>Active Clients</h3>
                        <p class="stat-number stat-value">0</p>
                        <span class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 0% from last month
                        </span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="stat-details">
                        <h3>Active Policies</h3>
                        <p class="stat-number stat-value">0</p>
                        <span class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 0% from last month
                        </span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-details">
                        <h3>All Time Premium</h3>
                        <p class="stat-number stat-value">$0</p>
                        <span class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 0% from last month
                        </span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-details">
                        <h3>Monthly Lead Premium</h3>
                        <p class="stat-number stat-value">$0</p>
                        <span class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 0% from last month
                        </span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="actions-grid">
                    <button class="action-btn" onclick="showNewQuote()">
                        <i class="fas fa-plus-circle"></i>
                        <span>New Quote</span>
                    </button>
                    <button class="action-btn" onclick="showNewClient()">
                        <i class="fas fa-user-plus"></i>
                        <span>Add Client</span>
                    </button>
                    <button class="action-btn" onclick="showRatingEngine()">
                        <i class="fas fa-calculator"></i>
                        <span>Compare Rates</span>
                    </button>
                    <button class="action-btn" onclick="showRenewalsList()">
                        <i class="fas fa-sync"></i>
                        <span>Renewals</span>
                    </button>
                    <button class="action-btn" onclick="showClaims()">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Claims</span>
                    </button>
                    <button class="action-btn" onclick="showReports()">
                        <i class="fas fa-chart-pie"></i>
                        <span>Reports</span>
                    </button>
                    <button class="action-btn" onclick="showAppSubmissions()">
                        <i class="fas fa-file-contract"></i>
                        <span>App Submissions</span>
                    </button>
                </div>
            </div>

            <!-- Main dashboard sections will be dynamically generated by loadFullDashboard() JavaScript function -->
            <!-- Removed static conflicting HTML to prevent conflicts with JavaScript-generated dashboard -->

            <!-- Charts Section Removed -->
        </section>
    </main>

    <!-- Rating Engine Modal -->
    <div id="ratingModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>Comparative Rating Engine</h2>
                <button class="close-btn" onclick="closeModal('ratingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="rating-form">
                    <h3>Get Instant Quotes from Multiple Carriers</h3>
                    <form id="ratingForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Insurance Type</label>
                                <select id="insuranceType">
                                    <option>Auto Insurance</option>
                                    <option>Homeowners Insurance</option>
                                    <option>Commercial Auto</option>
                                    <option>Commercial Property</option>
                                    <option>General Liability</option>
                                    <option>Life Insurance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Coverage Amount</label>
                                <input type="text" placeholder="$100,000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Client Name</label>
                                <input type="text" placeholder="Enter client name">
                            </div>
                            <div class="form-group">
                                <label>Effective Date</label>
                                <input type="date">
                            </div>
                        </div>
                        <button type="button" class="btn-primary" onclick="getQuotes()">
                            <i class="fas fa-search"></i> Get Quotes
                        </button>
                    </form>
                </div>
                
                <div id="quotesResults" class="quotes-results" style="display:none;">
                    <h3>Available Quotes</h3>
                    <div class="quotes-grid">
                        <div class="quote-card">
                            <div class="carrier-logo">
                                <img src="https://via.placeholder.com/100x40" alt="Carrier A">
                            </div>
                            <div class="quote-details">
                                <h4>Progressive</h4>
                                <p class="quote-price">$1,200<span>/year</span></p>
                                <ul class="coverage-list">
                                    <li><i class="fas fa-check"></i> Comprehensive Coverage</li>
                                    <li><i class="fas fa-check"></i> $500 Deductible</li>
                                    <li><i class="fas fa-check"></i> Roadside Assistance</li>
                                </ul>
                                <button class="btn-success">Select Quote</button>
                            </div>
                        </div>
                        <div class="quote-card">
                            <div class="carrier-logo">
                                <img src="https://via.placeholder.com/100x40" alt="Carrier B">
                            </div>
                            <div class="quote-details">
                                <h4>State Farm</h4>
                                <p class="quote-price">$1,350<span>/year</span></p>
                                <ul class="coverage-list">
                                    <li><i class="fas fa-check"></i> Premium Coverage</li>
                                    <li><i class="fas fa-check"></i> $250 Deductible</li>
                                    <li><i class="fas fa-check"></i> Rental Car Coverage</li>
                                </ul>
                                <button class="btn-success">Select Quote</button>
                            </div>
                        </div>
                        <div class="quote-card">
                            <div class="carrier-logo">
                                <img src="https://via.placeholder.com/100x40" alt="Carrier C">
                            </div>
                            <div class="quote-details">
                                <h4>Allstate</h4>
                                <p class="quote-price">$1,150<span>/year</span></p>
                                <ul class="coverage-list">
                                    <li><i class="fas fa-check"></i> Basic Coverage</li>
                                    <li><i class="fas fa-check"></i> $1000 Deductible</li>
                                    <li><i class="fas fa-check"></i> Liability Only</li>
                                </ul>
                                <button class="btn-success">Select Quote</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Client</h2>
                <button class="close-btn" onclick="closeModal('clientModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newClientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" name="lastName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="clientEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" name="clientPhone" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="clientAddress" placeholder="Street Address">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" name="clientCity">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <select name="clientState">
                                <option>Select State</option>
                                <option>NY</option>
                                <option>CA</option>
                                <option>TX</option>
                                <option>FL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" name="clientZip">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Assigned Agent</label>
                            <select name="assignedTo" style="width: 100%;">
                                <option value="">Unassigned</option>
                                <option value="Grant">Grant</option>
                                <option value="Carson">Carson</option>
                                <option value="Hunter">Hunter</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Representative</label>
                            <input type="text" name="representative" placeholder="Sales Representative">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('clientModal')">Cancel</button>
                        <button type="submit" class="btn-primary">Add Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Automation Center -->
    <div class="automation-panel" id="automationPanel" style="display:none;">
        <div class="panel-header">
            <h2>Automation Center</h2>
            <button onclick="hidePanel('automationPanel')" class="close-panel">&times;</button>
        </div>
        <div class="panel-content">
            <div class="automation-stats">
                <div class="auto-stat">
                    <i class="fas fa-robot"></i>
                    <div>
                        <h4>Active Workflows</h4>
                        <p>24</p>
                    </div>
                </div>
                <div class="auto-stat">
                    <i class="fas fa-clock"></i>
                    <div>
                        <h4>Time Saved</h4>
                        <p>156 hrs/month</p>
                    </div>
                </div>
                <div class="auto-stat">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <h4>Tasks Completed</h4>
                        <p>1,247</p>
                    </div>
                </div>
            </div>
            
            <div class="workflows-list">
                <h3>Automated Workflows</h3>
                <div class="workflow-item">
                    <div class="workflow-info">
                        <i class="fas fa-envelope"></i>
                        <div>
                            <h4>Welcome Email Series</h4>
                            <p>Sends 5 emails to new clients over 30 days</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="workflow-item">
                    <div class="workflow-info">
                        <i class="fas fa-bell"></i>
                        <div>
                            <h4>Renewal Reminders</h4>
                            <p>Auto-notify clients 60, 30, and 7 days before renewal</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="workflow-item">
                    <div class="workflow-info">
                        <i class="fas fa-file-invoice"></i>
                        <div>
                            <h4>Document Generation</h4>
                            <p>Auto-create certificates and ID cards</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="workflow-item">
                    <div class="workflow-info">
                        <i class="fas fa-chart-line"></i>
                        <div>
                            <h4>Lead Scoring</h4>
                            <p>Automatically score and prioritize new leads</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <button class="btn-primary full-width">
                <i class="fas fa-plus"></i> Create New Workflow
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- CDN Fallback Handler -->
    <!-- <script src="js/cdn-fallback.js"></script> DISABLED - Not needed for basic profile -->

    <!-- Agent Configuration -->
    <script src="js/agent-config.js"></script>

    <!-- Protect Vicidial leads from being removed -->
    <!-- <script src="js/protect-vicidial-leads.js?v=3"></script> DISABLED - May load leads -->
    <!-- Lead Archive System -->
    <script src="js/lead-archive-system.js?v=2"></script>
    <script src="js/api-service.js?v=27"></script>
    <!-- Fix ALL API ports BEFORE any other scripts -->
    <script src="js/fix-all-api-ports.js"></script>
    <script src="js/crm-api.js?v=1"></script>
    <script src="js/crm-integration-override.js?v=1"></script>
    <!-- DISABLED FOR TESTING - These were blocking leads -->
    <!-- <script src="js/nuclear-lead-cleanup.js?v=2"></script> -->
    <script src="js/integrations.js?v=20"></script>
    <!-- <script src="js/localStorage-interceptor.js?v=2"></script> -->
    <script src="js/data-sync.js?v=1"></script>
    <!-- Performance Optimization - MUST LOAD EARLY -->
    <script src="js/performance-optimization.js"></script>

    <!-- <script src="js/auto-clean-leads.js?v=3"></script> -->
    <script src="js/api-config-bridge.js?v=1"></script>
    <script src="js/fix-sip-configuration.js?v=1"></script>
    <script src="js/debug-sip-realtime.js?v=1"></script>
    <script src="js/sip-alternative-solutions.js?v=1"></script>
    <script src="js/fix-twilio-sip-only.js?v=1"></script>
    <script src="js/test-twilio-sip-setup.js?v=1"></script>
    <!-- DISABLED: SIP-blocking scripts to allow SIP softphone functionality
    <script src="js/bypass-sip-use-voice-api.js?v=1"></script>
    <script src="js/disable-sip-completely.js?v=1"></script>
    -->
    <!-- DISABLED: Mock script to enable real Twilio calls -->
    <!-- <script src="js/mock-twilio-for-testing.js?v=1"></script> -->
    <script src="js/final-phone-system-summary.js?v=1"></script>
    <script src="js/sip-test.js?v=2"></script>
    <script src="js/vanguard-softphone.js?v=9"></script>
    <script src="js/sip-integration-bridge.js?v=1"></script>
    <script src="js/force-policies-refresh.js?v=1"></script>
    <script src="js/app.js?v=1768160600_DEV_MODE_ADDED"></script>

    <!-- Vicidial Stage Sync - Bidirectional synchronization -->
    <script src="js/vicidial-stage-sync.js?v=1"></script>

    <!-- Console-Based Stats Tracker - LIVE SITE FIX -->
    <script>
        console.log('ðŸ”§ LIVE SITE: Console Call Tracker loading...');

        // Bridge to Live Stats Tracker - forwards calls to the real tracker
        window.consoleLiveStats = {
            // Get stats from the REAL live stats tracker
            getStats(agentName) {
                if (window.liveStatsTracker) {
                    return window.liveStatsTracker.getStats(agentName);
                }
                return {
                    totalCalls: 0,
                    totalCallDuration: 0,
                    totalLeads: 0,
                    highValueLeads: 0,
                    sessionsStartedAt: new Date().toISOString()
                };
            },

            // Reset stats using the REAL live stats tracker
            resetAgent(agentName) {
                if (window.liveStatsTracker) {
                    window.liveStatsTracker.resetAgent(agentName);
                    console.log(`ðŸ”„ LIVE SITE: Reset stats for ${agentName} via live tracker`);
                } else {
                    console.log(`âš ï¸ LIVE SITE: Live tracker not available for reset`);
                }
            },

            updateModalIfOpen(agentName) {
                setTimeout(() => {
                    const modals = document.querySelectorAll('div[style*="position: fixed"], [class*="modal"]');
                    modals.forEach(modal => {
                        const titleElements = modal.querySelectorAll('h2, h1');
                        titleElements.forEach(titleElement => {
                            if (titleElement && titleElement.textContent.includes(agentName) && titleElement.textContent.includes('Performance Profile')) {
                                console.log(`ðŸ”§ LIVE SITE: Found modal for ${agentName}, updating with console stats`);
                                this.updateModalStats(modal, agentName);
                            }
                        });
                    });
                }, 200);
            },

            updateModalStats(modal, agentName) {
                const agent = this.agents[agentName];
                if (!agent) return;

                console.log(`ðŸŽ¯ LIVE SITE: Updating modal for ${agentName} with console stats:`, agent);

                const allElements = modal.querySelectorAll('*');
                let foundCalls = false;

                allElements.forEach((element) => {
                    if (element.textContent && element.textContent.trim() === 'Total Calls' && !foundCalls) {
                        const parent = element.parentElement;
                        const numberElement = parent.querySelector('div[style*="font-size: 28px"]') ||
                                            parent.querySelector('div[style*="font-size:28px"]') ||
                                            parent.previousElementSibling ||
                                            element.previousElementSibling;

                        if (numberElement) {
                            const oldValue = numberElement.textContent;
                            console.log(`ðŸŽ¯ LIVE SITE: Found Total Calls element, updating from ${oldValue} to ${agent.totalCalls}`);
                            numberElement.textContent = agent.totalCalls;
                            numberElement.style.color = agent.totalCalls > 0 ? '#059669' : '#dc2626';
                            foundCalls = true;

                            // Flash green to show it updated
                            numberElement.style.background = '#10b981';
                            numberElement.style.color = 'white';
                            setTimeout(() => {
                                numberElement.style.background = '';
                                numberElement.style.color = agent.totalCalls > 0 ? '#059669' : '#dc2626';
                            }, 1000);
                        }
                    }

                    if (element.textContent && element.textContent.includes('Total Call Duration')) {
                        const parent = element.parentElement;
                        const numberElement = parent.querySelector('div[style*="font-size: 28px"]') ||
                                            parent.querySelector('div[style*="font-size:28px"]') ||
                                            parent.previousElementSibling;

                        if (numberElement) {
                            console.log(`ðŸŽ¯ LIVE SITE: Found Total Call Duration element, updating to ${agent.totalCallDuration}`);
                            numberElement.textContent = agent.totalCallDuration;
                            numberElement.style.color = agent.totalCallDuration > 0 ? '#0ea5e9' : '#dc2626';
                        }
                    }
                });
            }
        };

        // Helper functions
        window.checkConsoleStats = function(agentName = 'Carson') {
            const stats = window.consoleLiveStats.getStats(agentName);
            console.log(`ðŸŽ¯ LIVE SITE: Console stats for ${agentName}:`, stats);
            return stats;
        };

        window.resetConsoleStatsNow = function(agentName = 'Carson') {
            console.log(`ðŸ”„ LIVE SITE: Direct reset for ${agentName}`);
            if (window.consoleLiveStats) {
                window.consoleLiveStats.resetAgent(agentName);
                console.log(`âœ… LIVE SITE: Reset complete for ${agentName}`);
                return true;
            }
            return false;
        };

        // Override existing reset function when available
        function tryResetOverride() {
            if (window.resetAgentCounter) {
                const original = window.resetAgentCounter;
                window.resetAgentCounter = function(agentName) {
                    console.log(`ðŸ”„ LIVE SITE: Override reset called for ${agentName}`);

                    // Reset console stats first
                    if (window.consoleLiveStats) {
                        window.consoleLiveStats.resetAgent(agentName);
                    }

                    // Call original
                    if (original) original(agentName);

                    console.log(`âœ… LIVE SITE: Override reset complete for ${agentName}`);
                };
                console.log('ðŸ”— LIVE SITE: Reset override installed');
            } else {
                setTimeout(tryResetOverride, 1000);
            }
        }

        // Start override attempt
        setTimeout(tryResetOverride, 3000);

        console.log('âœ… LIVE SITE: Console tracker loaded - use checkConsoleStats("Carson") and resetConsoleStatsNow("Carson")');
    </script>

    <!-- Universal Live Stats Fix - MUST load after app.js -->
    <script src="js/fix-all-agent-live-stats.js?v=5"></script>
    <!-- Enhanced Lead Management with DELETE functionality - MUST load after app.js -->
    <script src="js/enhanced-lead-management.js?v=2"></script>

    <!-- Emergency fixes for hardcoded button IDs -->
    <!-- <script src="js/emergency-viewlead-fix.js?v=1"></script> DISABLED - Breaking other tabs -->
    <script src="js/fix-hardcoded-button-ids.js?v=2"></script>

    <!-- My Leads Only Toggle - Direct Implementation -->
    <!-- <script src="js/my-leads-toggle.js?v=9"></script> DISABLED - Complex approach -->
    <script src="js/my-leads-toggle-direct.js?v=3"></script>

    <!-- Twilio Voice WebRTC Softphone (proper Twilio implementation) -->
    <script src="js/twilio-voice-webrtc-phone.js?v=9"></script>

    <!-- Asterisk SIP Configuration for CRM-Zoiper Integration -->
    <script src="asterisk-sip-config.js?v=1"></script>

    <!-- Archived Leads Functionality -->
    <script src="js/archived-leads-functionality.js?v=3"></script>

    <!-- NUCLEAR HIGHLIGHTING FIX - Bulletproof highlighting that cannot be removed -->
    <!-- <script src="js/nuclear-highlighting-fix.js?v=6"></script> DISABLED - Intercepting viewLead -->

    <!-- Protect ViciDial leads stored in database from localStorage clearing -->
    <script src="js/protect-database-leads.js?v=6_CLEAN_LOGGING"></script>
    <!-- Protect campaign modals from global click handler interference -->
    <script src="js/protect-campaign-modal.js?v=1"></script>

    <script src="js/restore-coi-features.js?v=1"></script>

    <!-- CRITICAL: Load Titan emails immediately after app.js so loadCOIInbox function is available -->
    <script src="js/titan-emails-only-simple.js?v=6"></script>

    <!-- TITAN COI EMAIL COMPOSE MOVED TO END TO PREVENT OVERRIDES -->

    <!-- COI Form and Signature Scripts -->
    <script src="js/coi-form-capture.js?v=1"></script>
    <script src="js/coi-signature-modal.js?v=1"></script>
    <!-- Fix Archived Leads Permanently - Must load EARLY to override sync functions -->
    <script src="js/fix-archived-leads-permanent.js?v=2"></script>
    <script src="js/ai-functions-fallback.js"></script>
    <script src="debug-agent-save.js"></script>
    <script src="js/policy-modal.js?v=30"></script>
    <script src="js/policy-quickfill.js?v=1"></script>
    <script src="js/fix-policy-server-save.js?v=1"></script>
    <script src="js/policy-to-client-auto-sync.js?v=1"></script>
    <script src="js/admin-coi-upload-enhancement.js?v=1"></script>
    <script src="js/debug-policy-modal.js?v=1"></script>
    <script src="js/universal-coi-upload.js?v=1"></script>
    <script src="js/fix-policy-types.js"></script>
    <!-- Removed carrier-profile-fixed.js to avoid conflicts -->
    <script src="js/database-connector.js?v=22"></script>
    <script src="vicidial-config.js"></script>
    <script src="js/vicidial-integration.js"></script>
    <script src="js/vicidial-uploader.js?v=6"></script>
    <!-- DISABLED: Conflicts with selective sync - <script src="js/vicidial-sync-restored.js"></script> -->
    <!-- Telnyx WebRTC SDK for browser calling -->
    <script src="https://unpkg.com/@telnyx/webrtc@2.10.1/lib/bundle.js"></script>
    <script src="js/telnyx-webrtc.js?v=1"></script>
    <script src="js/tool-windows.js?v=11"></script>
    <script src="js/twilio-sip.js?v=3"></script>
    <script src="js/click-to-dial-email.js"></script>
    <script src="js/integrations-config.js"></script>
    <script src="js/dashboard-stats.js?v=27"></script>
    <!-- <script src="js/recent-activities.js?v=32"></script> Temporarily disabled -->
    <script src="js/dashboard-renewals.js?v=2"></script>
    <script src="js/renewal-persistence-loader.js?v=1"></script>
    <script src="js/fix-renewal-finalize-update.js?v=2"></script>
    <script src="js/renewal-finalize-indicator.js?v=2"></script>
    <script src="js/communications-reminders.js?v=1"></script>
    <script src="js/test-communications-data.js?v=1"></script>
    <script src="js/clear-test-clients.js?v=1"></script>
    <!-- <script src="js/load-vicidial-leads.js"></script> DISABLED - Auto-loads mock data -->
    <script src="js/load-vicidial-transcripts.js"></script>
    <!-- <script src="js/fix-navigation.js"></script> -->
    <!-- Re-enabled for proper profile function - MOVED TO LOAD LATER -->
    <!-- <script src="js/final-profile-fix.js?v=1004"></script> MOVED -->
    <script src="js/debug-script-loading.js?v=1"></script>
    <script src="js/add-test-button.js"></script>
    <!-- Fixed with role-based filtering and assigned column -->
    <script src="js/fix-clients-view.js?v=1733252400_CLIENTS_FIXED"></script>
    <!-- DISABLED: Conflicts with original-client-profile.js
    <script src="js/fix-client-profile-policies.js"></script> -->
    <!-- TEMPORARILY DISABLED - This was blocking Vicidial lead imports -->
    <!-- <script src="js/fix-lead-persistence.js"></script> -->
    <script src="js/fix-stage-update.js"></script>
    <script src="js/fix-stage-save-to-db.js"></script>
    <script src="js/ai-lead-caller.js"></script>
    <script src="js/create-sample-ai-campaign.js"></script>
    <script src="js/sms-persistence-test.js"></script>
    <script src="js/quote-application.js?v=1"></script>
    <script src="js/quote-application-server.js"></script>
    <script src="js/test-quote-modal.js"></script>
    <script src="js/quote-applications-view.js"></script>
    <!-- <script src="js/fix-quote-application-button.js"></script> DISABLED - Intercepting viewLead -->
    <script src="js/show-comprehensive-application.js"></script>
    <script src="js/app-submissions.js"></script>
    <script src="js/force-app-submissions-local.js"></script>
    <script src="js/fix-quote-application-click.js"></script>
    <script src="js/cleanup-modals.js"></script>
    <!-- Ensure required functions exist -->
    <script src="js/ensure-functions.js?v=STAGE_COLORS_FIX"></script>
    <!-- USING PROFILE FROM SEP 22 -->
    <!-- <script src="js/final-profile-fix.js?v=1004"></script> DISABLED - Duplicate loading -->
    <!-- DEBUG: Monitor localStorage persistence -->
    <script src="js/debug-localstorage-persistence.js"></script>
    <script src="js/fix-stage-saving-unified.js?v=4"></script>
    <!-- Critical Lead Profile Scripts from Working System -->
    <!-- <script src="js/fix-lead-table-eye-icon-only.js"></script> DISABLED - Annoying loading overlay -->
    <script src="js/fix-profile-quotes.js"></script>
    <script src="js/fix-add-quote-direct.js"></script>
    <!-- <script src="js/load-display-quotes.js"></script> DISABLED - May interfere with profile -->
    <!-- <script src="js/load-lead-from-api.js"></script> DISABLED - Conflicting with profile display -->
    <!-- <script src="js/force-save-button-v2.js"></script> DISABLED - Interfering with modal -->
    <!-- Demo Data Blocking Script -->
    <script src="js/block-demo-data-import.js"></script>
    <!-- Fix Profile Display Issues - DISABLED: Conflicts with profile loading -->
    <!-- <script src="js/fix-profile-display.js"></script> -->
    <!-- Fix Profile Position -->
    <!-- <script src="js/fix-profile-position.js"></script> DISABLED - Interfering with modal -->
    <!-- Fix Gmail API URL -->
    <!-- DISABLED: Interfering with Titan email expansion - <script src="js/fix-gmail-api-url.js"></script> -->
    <!-- Connect eye icon to proper profile -->
    <script src="js/connect-eye-icon-properly.js?v=1"></script>
    <!-- Fix viewLead to use createEnhancedProfile -->
    <!-- <script src="js/fix-viewlead-proper.js"></script> DISABLED - Creates loading overlay -->
    <!-- Disabled: Overrides viewLead incorrectly
    <script src="js/save-button-in-profile.js"></script> -->
    <!-- <script src="js/debug-lead-storage.js"></script> DISABLED - Intercepting viewLead -->
    <!-- DISABLED: <script src="js/unarchive-all-leads.js"></script> CAUSING LEADS TO DISAPPEAR AFTER IMPORT -->
    <!-- <script src="js/fix-lead-not-found.js"></script> DISABLED - Intercepting viewLead -->

    <!-- ALL RECENTLY CREATED PROFILE SCRIPTS DISABLED -->
    <!-- <script src="js/use-original-app-profile.js"></script> -->
    <!-- <script src="js/lead-profile-enhanced.js"></script> -->
    <!-- <script src="js/connect-viewlead.js"></script> -->
    <!-- <script src="js/simple-lead-profile.js"></script> -->
    <!-- <script src="js/fix-view-lead-click.js"></script> -->
    <!-- <script src="js/keep-profile-open.js"></script> -->
    <!-- <script src="js/restore-original-profile.js"></script> -->
    <!-- Removed debug script that adds test button -->
    <!-- <script src="js/debug-profile-open.js"></script> -->
    <!-- DISABLED - This script was blocking lead imports with "No new leads to import" message -->
    <!-- <script src="js/sync-new-vicidial-leads.js"></script> -->
    
    <!-- Commented out scripts causing connection errors
    <!-- <script src="js/import-new-leads-now.js"></script> DISABLED - Auto-imports leads on page load -->
    <!-- <script src="js/force-sync-leads.js"></script> DISABLED - Adds mock data automatically -->
    -->
    <!-- <script src="js/direct-import-leads.js"></script> -->
    <!-- <script src="js/remove-fake-leads.js"></script> -->
    <!-- Previous sync attempts - disabled -->
    <!-- <script src="js/manual-vicidial-sync.js"></script> -->
    <!-- <script src="js/force-real-sync.js"></script> -->
    <!-- <script src="js/fix-lead-addition.js"></script> -->
    
    <!-- Working sync solution - These are the ONLY active sync scripts -->
    <!-- <script src="js/vicidial-sync-with-transcription.js"></script> DISABLED - conflicts with enhanced selective sync -->
    <script src="js/add-sync-button.js"></script>
    <script src="js/manual-lead-refresh.js"></script>
    <script src="js/emergency-lead-refresh.js"></script>
    <!-- MAIN IMPORT SCRIPT - Full data import with transcripts, vehicles, notes -->
    <!-- <script src="js/vicidial-full-data-import.js?v=2"></script> DISABLED - Imports leads -->
    <!-- Enhanced lead details view to show all the imported data -->
    <!-- <script src="js/enhanced-lead-details.js"></script> DISABLED - May load leads -->
    <!-- Backup scripts if needed -->
    <!-- <script src="js/force-show-vicidial-leads.js"></script> -->
    <!-- <script src="js/reset-and-import.js"></script> -->
    <!-- <script src="js/fix-lead-table.js"></script> -->
    <!-- <script src="js/fix-lead-display.js"></script> -->
    <!-- <script src="js/force-add-vicidial-leads.js"></script> -->
    
    <!-- Loading Spinner Fix - DISABLED -->
    <!-- <script src="js/fix-loading-spinner.js"></script> -->

    <!-- Lead Archive System - DISABLED -->
    <!-- <script src="js/lead-archive-system.js?v=2"></script> -->
    
    <!-- Deduplication System - Prevents duplicates across leads, clients, archives -->
    <script src="js/deduplication-system.js?v=2"></script>
    
    <!-- Bulk Client Import - 21 clients ready to import -->
    <script src="js/bulk-import-clients.js?v=2"></script>
    
    <!-- Fix Client IDs to prevent JavaScript errors -->
    <script src="js/fix-client-ids.js?v=1"></script>
    
    <!-- Client Pagination System - 12 clients per page -->
    <!-- DISABLED: Uses outdated client.policies array and wrong premium field
    <script src="js/client-pagination.js?v=2"></script> -->
    
    <!-- Fix stuck leads -->
    <!-- <script src="js/fix-stuck-leads.js?v=1"></script> DISABLED - May load leads -->
    
    <!-- FMCSA Data Updater - Updates client data from FMCSA API -->
    <script src="js/fmcsa-data-updater.js?v=1"></script>
    
    <!-- FMCSA Insurance Lead Generator - Uses insurance API for lead generation -->
    <!-- <script src="js/fmcsa-insurance-leads.js?v=1"></script> DISABLED - Generates leads -->
    
    <!-- Fix Policy View Modal Tabs - Makes tabs properly show/hide content -->
    <script src="js/fix-policy-view-tabs.js?v=1"></script>
    
    <!-- Fix Policy Management Statistics - Calculate actual values from data -->
    <script src="js/fix-policy-stats.js?v=1"></script>

    <!-- Fix Policy Display Limit - Resolves 2-policy display limitation -->
    <script src="js/fix-policy-display-limit.js?v=1"></script>

    <!-- Policy Fix - Ensures policies always load from server first -->
    <script src="js/policy-fix.js?v=1"></script>

    <!-- Force FMCSA Update - Temporary script to force immediate update -->
    <script src="js/force-fmcsa-update.js?v=1"></script>
    
    <!-- Force restore Vicidial leads - MUST BE LAST -->
    <script src="js/force-restore-vicidial.js?v=1"></script>
    
    <!-- Cloud Sync System - Syncs data across all devices and accounts -->
    <!-- Removed firebase-sync.js to disable Export/Import/Gist popup -->
    
    <!-- Optional: Firebase SDK for real-time sync (uncomment to enable) -->
    <!--
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    -->

    <!-- ORIGINAL CLIENT PROFILE - Must be LAST to override all other viewClient functions -->
    <script src="js/original-client-profile.js?v=2"></script>

    <!-- FINAL PROFILE FIX - Must load AFTER all other lead profile scripts to ensure functions are available -->
    <!-- <script src="js/final-profile-fix.js?v=1005"></script> REPLACED WITH PROTECTED VERSION -->

    <!-- TEST SCRIPT EXECUTION -->
    <script src="js/test-script-execution.js?v=1"></script>

    <!-- FIX PREMIUM DISPLAY -->
    <script src="js/fix-premium-display.js?v=1733252400_FIX_CLIENT_IDS"></script>

    <!-- FINAL PROFILE FIX PROTECTED - MUST BE ABSOLUTELY LAST - Cannot be overridden -->
    <script src="js/final-profile-fix-protected.js?v=20250115_REMAINING_TIME_FIX"></script>

    <!-- Test ReachOut Consistency -->
    <script src="js/test-reachout-consistency.js?v=20250112_163215"></script>

    <!-- Debug Lead ID Corruption -->
    <script src="js/debug-lead-id-corruption.js?v=20250112_164500"></script>

    <!-- Prevent Fast Click Timing Issue -->
    <script src="js/prevent-fast-click-timing-issue.js?v=20250112_165000"></script>

    <!-- Fix Reports Call Counting -->
    <script src="js/fix-reports-call-counting-simple.js?v=20250112_173500"></script>

    <!-- Test Agent Modal -->
    <script src="js/test-agent-modal.js?v=20250112_172000"></script>

    <!-- Policy function override - ensures policy functions take precedence in policy modals -->
    <script src="js/policy-function-override.js?v=1"></script>

    <!-- PREVENT TAB SWITCHING OVERRIDE - DISABLED because it blocks legitimate lead loading -->
    <!-- <script src="js/prevent-tab-switching-override.js?v=1"></script> -->

    <!-- ENSURE CORRECT LEAD TABLE - Force correct highlighted view to load -->
    <!-- <script src="js/ensure-correct-lead-table.js?v=16"></script> DISABLED - Causing blinking conflicts -->

    <!-- TEST SCRIPTS DISABLED - Using comprehensive script only -->

    <!-- COI Email Integration - Auto-switches between Gmail and Outlook -->
    <!-- DISABLED: Interfering with Titan - <script src="js/coi-email-integration.js?v=1"></script> -->

    <!-- COI Gmail Proxy - DISABLED: Was overriding with demo data
    <script src="js/coi-gmail-proxy.js?v=1"></script> -->

    <!-- COI Email Fix - Ensures email expansion works -->
    <!-- DISABLED: Interfering with Titan - <script src="js/coi-email-fix.js?v=2"></script> -->
    <!-- COI Real Policies - Load policies from localStorage -->
    <script src="js/coi-real-policies.js?v=13"></script>
    <!-- COI Policy Sync - Keep policies in sync -->
    <script src="js/coi-policy-sync.js?v=1"></script>
    <!-- COI Panel Toggle - Minimize/Maximize functionality -->
    <script src="js/coi-panel-toggle.js?v=3"></script>

    <!-- Prevent duplicate policy loads - MUST LOAD AFTER COI SCRIPTS -->
    <script src="js/preserve-coi-policy-list.js"></script>

    <!-- COI Field Mapping Fix - Enhanced field extraction for policy data -->
    <script src="js/coi-field-mapping-fix.js?v=2"></script>
    <!-- ULTIMATE ACORD FIX - This WILL show real ACORD form -->
    <!-- Remove ultimate-acord-fix as it conflicts -->
    <!-- <script src="js/ultimate-acord-fix.js?v=2"></script> -->
    <!-- Carrier Import System - Import from Progressive, GEICO, etc -->
    <script src="js/carrier-import-system.js?v=1"></script>
    <!-- FORCE REAL EMAILS - Aggressively loads real Gmail emails -->
    <!-- DISABLED: Interfering with Titan - <script src="js/coi-force-real-emails.js?v=2"></script> -->
    <!-- DISABLED: Interfering with Titan email expansion - COI Inbox Fix - Fixes back arrow navigation -->
    <!-- <script src="js/coi-inbox-fix.js?v=1"></script> -->

    <!-- CRITICAL SEPT 29 FIXES - Restoring missing functionality -->
    <!-- Sept 29 ACORD display -->
    <!-- <script src="js/acord-25-display.js?v=1"></script> -->
    <script src="js/fix-everything-final.js?v=1"></script>
    <script src="js/email-status-tracker.js?v=6"></script>
    <script src="js/fix-view-email-details.js?v=1"></script>
    <script src="js/fix-back-to-inbox.js?v=1"></script>
    <script src="js/disable-popups.js?v=1"></script>
    <!-- COI Back Arrow Ultimate Fix - Ensures back arrow works -->
    <script src="js/coi-back-arrow-fix.js?v=1"></script>
    <!-- COI Button Intercept - Directly intercepts back button clicks -->
    <script src="js/coi-button-intercept.js?v=1"></script>
    <!-- COI Email Read Status - Tracks and styles read/unread emails -->
    <!-- DISABLED: Interfering with Titan - <script src="js/coi-email-read-status.js?v=2"></script> -->
    <!-- COI Hover Fix - AGGRESSIVE fix for hover behavior -->
    <script src="js/coi-hover-fix.js?v=1"></script>
    <!-- COI Inline Style Fix - Forces inline styles for emails -->
    <script src="js/coi-inline-style-fix.js?v=1"></script>
    <!-- Real ACORD 25 Display - Shows actual ACORD 25 certificate form -->
    <!-- <script src="js/real-acord-25-display.js?v=1"></script> -->
    <!-- ACORD PDF Viewer - Displays the real fillable ACORD 25 PDF -->
    <!-- <script src="js/acord-pdf-viewer.js?v=1"></script> -->
    <!-- FORCE ACORD PDF - Ultimate override to ensure real PDF shows -->
    <!-- <script src="js/force-acord-pdf.js?v=1"></script> -->
    <!-- ACORD PDF Pre-fill - Fills ACORD with policy data -->
    <!-- <script src="js/acord-pdf-prefill.js?v=1"></script> -->
    <!-- ACORD Simple View - Clean PDF display with email/save -->
    <!-- <script src="js/acord-simple-view.js?v=1"></script> -->
    <!-- ACORD Stable View - Prevents zoom changes -->
    <!-- <script src="js/acord-stable-view.js?v=1"></script> -->
    <!-- ACORD Auto-Fill - Fills PDF with policy data -->
    <!-- <script src="js/acord-auto-fill.js?v=1"></script> -->
    <!-- ACORD Form Filler - Shows filled data on PDF -->
    <!-- <script src="js/acord-form-filler.js?v=1"></script> -->
    <!-- Load PDF.js and jsPDF for ACORD form handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        if (window.jspdf) {
            window.jsPDF = window.jspdf.jsPDF;
        }
    </script>
    <!-- Save to Profile functionality - MUST load before ACORD viewers -->
    <script src="js/save-to-profile.js?v=14"></script>
    <!-- Load ACORD Real Viewer for PDF with fillable fields overlay -->
    <script src="js/acord-real-viewer.js?v=6"></script>
    <!-- Load the ACORD 25 Display with download/print functions -->
    <!-- Disabled because it conflicts with real viewer -->
    <!-- <script src="js/acord-25-display.js?v=2"></script> -->
    <!-- Load ACORD Embedded handler - this must be last to override prepareCOI -->
    <script src="js/acord-25-embedded.js?v=2"></script>
    <!-- COI Email System with PDF Attachment -->
    <!-- DISABLED: Interfering with Titan - <script src="js/coi-email-with-pdf.js?v=5"></script> -->
    <!-- DISABLED: Interfering with Titan - <script src="js/coi-email-final-override.js?v=2"></script> -->
    <!-- Fix ACORD Download and Print functions -->
    <script src="js/fix-acord-download-print.js?v=1"></script>
    <!-- Removed lead-filter-530.js to disable 5/30 Filter button -->
    <!-- Carrier Profile Modal - Shows comprehensive carrier details with inspections -->
    <script src="js/carrier-profile-modal.js?v=5"></script>
    <!-- Carrier Profile Integration - Links eye icon to carrier profile -->
    <script src="js/carrier-profile-integration.js?v=5"></script>
    <!-- DISABLED: Conflicting with final-profile-fix.js
    <script src="js/fix-eye-icon-viewlead.js?v=2"></script>
    <script src="js/ultimate-eye-icon-fix.js?v=1"></script> -->
    <!-- COI Reply System - Enable email replies -->
    <script src="js/coi-reply-system.js?v=1"></script>
    <!-- Aggressive Back Fix - Auto-reload emails when back arrow clicked -->
    <script src="js/aggressive-back-fix.js?v=1"></script>
    <!-- Force Policy List Navigation - Ensures Policy Profile back button goes to Policy List -->
    <script src="js/force-policy-list-navigation.js?v=1"></script>
    <!-- DEBUG Navigation Loop - Find the real cause of the loop -->
    <!-- <script src="js/debug-navigation-loop.js?v=1"></script> -->
    <!-- Only Check X Buttons - Force status buttons to show -->
    <!-- DISABLED: Interfering with Titan - <script src="js/only-check-x-buttons.js?v=2"></script> -->
    <!-- Renewal Tasks Server Storage - Save task completion to server -->
    <!-- TEMPORARILY DISABLED for COI performance - <script src="js/renewal-tasks-server.js?v=1"></script> -->

    <!-- Fix Archive Persistence - Prevent archived leads from reappearing -->
    <!-- DISABLED - Conflicting with proper-archive-system.js -->
    <!-- <script src="js/fix-archive-persistence.js?v=1"></script> -->
    <!-- DISABLED - Conflicting with proper-archive-system.js -->
    <!-- <script src="js/enforce-archive-separation.js"></script> -->
    <!-- Fix permanent delete - prevent deleted leads from reappearing -->
    <!-- <script src="js/fix-permanent-delete.js"></script> DISABLED - Conflicting with archive system -->

    <!-- DISABLED - This was causing archived leads to reappear -->
    <!-- <script src="js/fix-aggressive-lead-restore.js?v=1"></script> -->

    <!-- MOVED TO END: ULTIMATE Gmail Fix -->

    <!-- Fix Policy Data Contamination - Separates Adam 1 and Du Road policies -->
    <script src="js/fix-policy-data.js?v=1"></script>

    <!-- Format Coverage Limits with Commas - Auto-formats all coverage amounts -->
    <script src="js/format-coverage-limits.js?v=1"></script>

    <!-- Complete Fix for Lead Creation - Ensures leads save with all data -->
    <!-- <script src="js/fix-lead-creation-complete.js?v=1"></script> DISABLED - Intercepting viewLead -->

    <!-- FINAL Lead System Fix - DISABLED (conflicting with main app.js) -->
    <!-- <script src="js/fix-lead-system-final.js?v=1"></script> -->

    <!-- DEBUG NEW LEAD CREATION - Comprehensive debugging -->
    <script src="debug-new-lead.js"></script>

    <!-- Auto-select client when navigating from incoming calls -->
    <script src="js/auto-select-client.js"></script>

    <!-- Direct client profile navigation -->
    <script src="js/client-profile-router.js"></script>

    <!-- Clean up invalid leads with undefined IDs -->
    <script src="js/clean-undefined-leads.js?v=1"></script>

    <!-- Complete fix for unarchive functionality -->
    <script src="js/fix-unarchive-complete.js?v=1"></script>

    <!-- Unified stage saving fix - ensures ALL leads save properly -->
    <!-- Moved to load right after final-profile-fix.js -->
    <!-- <script src="js/fix-stage-saving-unified.js?v=1"></script> -->

    <!-- Agent assignment persistence fix - saves assigned_to field to server -->
    <script src="js/fix-agent-assignment-persistence.js?v=2"></script>

    <!-- Add Assigned To dropdown to lead profiles - DISABLED: Conflicts with profile loading -->
    <!-- <script src="js/add-assigned-to-dropdown.js?v=2"></script> -->

    <!-- Authentication Manager -->
    <script src="js/auth-manager.js?v=1"></script>

    <!-- User-specific COI Customization -->
    <script src="js/user-coi-customization.js?v=1"></script>

    <!-- Sticky Table Header Enhancement -->
    <script src="js/sticky-header-enhancement.js?v=1"></script>

    <!-- Proper Archive System - Moves leads between tables -->
    <script src="js/proper-archive-system.js?v=1"></script>

    <!-- DISABLED - Using real database dates instead -->
    <!-- <script src="js/fix-export-dates.js"></script> -->

    <!-- Export REAL Database Dates - Fetches actual renewal dates from FMCSA database -->
    <script src="js/export-real-database-dates.js"></script>

    <!-- Fix Lead Generation to use REAL database data -->
    <script src="js/fix-lead-gen-real-data.js?v=fcsma4"></script>

    <!-- FCSMA API Override - Replace external API with local FCSMA database -->
    <script src="js/fcsma-api-override-v5.js?v=20251015_fixed_endpoint"></script>

    <!-- Remove Maureen's clients from the system -->
    <script src="js/remove-maureen-clients.js?v=2"></script>
    <script src="js/aggressive-maureen-cleaner.js?v=1"></script>

    <!-- DISABLED: Interfering with Titan emails - Gmail Fix MUST be absolutely LAST to override all other expandEmail functions -->
    <!-- <script src="js/fix-gmail-ultimate.js?v=8&t=1729480400"></script> -->

    <!-- Fix Missing Leads Display -->
    <script src="js/fix-missing-leads-display.js?v=1"></script>

    <!-- DISABLED: Conflicts with selective sync - Enhanced Vicidial Sync - MUST load last to override other sync functions -->
    <!-- <script src="js/enhanced-vicidial-sync.js?v=1"></script> -->

    <!-- Fix Lead Generation Function - MUST be absolutely LAST -->
    <script src="js/fix-lead-generation-function.js?v=1"></script>

    <!-- Maureen United Insurance Group - Changes company name when Maureen Corp signs -->
    <script src="js/maureen-united-insurance.js?v=1"></script>

    <!-- RESTORE Complete Lead Generation Functionality - MUST BE LAST -->
    <!-- Enabled lead generation scripts for full functionality -->
    <script src="js/restore-lead-generation-complete.js?v=1"></script>
    <!-- <script src="js/counts-only-lead-generation.js?v=3"></script> -->

    <!-- Complete Lead Generation with Day Skip feature -->
    <script src="js/complete-lead-generation-restoration.js?v=11"></script>

    <!-- Fix Lead Generation to use Matched Carriers CSV Database - MUST LOAD AFTER COMPLETE RESTORATION -->
    <script src="js/fix-lead-generation-matched-carriers.js?v=10"></script>

    <!-- Selective Vicidial Sync - Choose which leads to import - MUST BE ABSOLUTELY LAST -->
    <script src="js/selective-vicidial-sync-clean.js?v=21"></script>

    <!-- Fix ViciDial Deleted Filter - Clear ViciDial leads from deleted list -->
    <script src="js/fix-vicidial-deleted-filter.js?v=1"></script>

    <!-- Incremental Agent Performance Tracking System -->
    <script src="js/incremental-agent-tracking.js?v=1"></script>

    <!-- Enhanced Agent Performance with Time-Based Reports and Reset Button -->
    <script src="js/enhanced-agent-performance.js?v=1"></script>

    <!-- Force Add ViciDial Report Button to Agent Performance -->
    <script src="js/add-vicidial-button.js?v=4"></script>

    <!-- Fix Eye Icon Lead IDs - ensures each eye button has correct lead ID -->
    <script src="js/fix-eye-icon-lead-ids.js?v=1"></script>

    <!-- Fix Agent Performance Counts - Only count leads created in period + Dev Mode -->
    <script src="js/fix-agent-performance-counts.js?v=2"></script>
    <script src="js/simple-dev-controls.js?v=32"></script>
    <script src="js/live-stats-tracker.js?v=32"></script>
    <script src="js/live-stats-integration.js?v=32"></script>
    <script src="js/force-live-stats-override.js?v=33"></script>

    <!-- Force COI to use Outlook instead of Gmail - MUST BE ABSOLUTELY LAST -->
    <!-- DISABLED: Contains mock data - <script src="js/coi-use-outlook.js?v=1"></script> -->

    <!-- DISABLED: May interfere - <script src="js/disable-all-gmail.js?v=1"></script> -->

    <!-- DISABLED: File doesn't exist - <script src="js/fetch-real-outlook-emails.js?v=1"></script> -->

    <!-- DISABLED: Was adding mock data - <script src="js/force-outlook-only.js?v=1"></script> -->

    <!-- DISPLAY REAL OUTLOOK EMAILS - Find test2006 -->
    <!-- DISABLED: Mock data source - <script src="js/display-real-outlook-emails.js?v=1"></script> -->

    <!-- DISABLED: Being replaced with titan-emails-only.js
    <script src="js/force-real-outlook-emails.js?v=4"></script> -->

    <!-- TITAN SCRIPT MOVED TO LOAD RIGHT AFTER APP.JS -->

    <!-- TITAN COI EMAIL COMPOSE - MUST BE LAST TO OVERRIDE ACORD SCRIPTS -->
    <script src="js/coi-email-compose-titan.js?v=4"></script>

    <!-- PDF COMPARISON TEST -->
    <script src="test-pdf-comparison.js"></script>

    <!-- DISABLED: This was hiding all renewal cards with negative days
    <script src="js/remove-overdue-renewals.js?v=1"></script>
    -->

    <!-- Fix ViciDial lead display after import -->
    <script src="js/fix-vicidial-lead-display.js?v=1"></script>

    <!-- Fix instant delete - remove leads immediately from UI -->
    <script src="js/fix-instant-delete.js?v=3"></script>

    <!-- BULLETPROOF DELETE - Must load AFTER other delete scripts to override them -->
    <script src="js/bulletproof-delete.js?v=2"></script>

    <!-- DEBUG DELETE TEST - Console testing tools -->
    <script src="js/debug-delete-test.js?v=1"></script>

    <!-- SUPER SIMPLE DELETE - Final override with hardcoded URL -->
    <script src="js/super-simple-delete.js?v=1"></script>

    <!-- DATABASE SYNC FIX - Ensures all operations use the correct backend database -->
    <!-- <script src="js/fix-database-sync.js?v=1"></script> DISABLED - May be removing leads -->

    <script src="js/cleanup-invalid-leads.js?v=1"></script>

    <!-- Fix button flashing/flickering issue -->
    <script src="js/fix-button-flashing.js?v=1"></script>

    <!-- Fix new lead form - remove Lead Source and improve validation -->
    <script src="js/fix-new-lead-form.js?v=1"></script>

    <!-- Transcriptions now processed by backend with Deepgram and OpenAI -->

    <!-- Fix stage count display issue - prevents "$0$0$0..." concatenation -->
    <script src="js/fix-stage-count-display.js?v=1"></script>

    <!-- Fix stage count concatenation - ensures numeric addition -->
    <!-- <script src="js/fix-stage-count-concatenation.js?v=1"></script> -->

    <!-- Fix Assigned To column sorting -->
    <script src="js/fix-assigned-to-sorting.js?v=1"></script>

    <!-- TEST SCRIPT LOADING -->
    <script>
        console.log('ðŸ”¥ TEST: Script loading starting...');
    </script>

    <!-- FORCE RELOAD ENHANCED PROFILE - VERSION 1764538875 -->
    <script>
        console.log('ðŸ”¥ FORCE-1764538875: Creating enhanced profile function directly...');

        window.createEnhancedProfile = function(lead) {
            console.log('âœ… DIRECT: Enhanced profile called for:', lead.name);

            // Remove any existing modals
            const existing = document.getElementById('lead-profile-container');
            if (existing) existing.remove();

            // Create the original enhanced profile modal with YOUR features
            const modalContainer = document.createElement('div');
            modalContainer.id = 'lead-profile-container';
            modalContainer.style.cssText = \`
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.5); display: flex; align-items: center;
                justify-content: center; z-index: 999999; padding: 20px;
            \`;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = \`
                background: white; border-radius: 12px; max-width: 1400px; width: 100%;
                max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            \`;

            modalContent.innerHTML = \`
                <div style="padding: 24px 30px; background: linear-gradient(135deg, #0066cc 0%, #004999 100%);
                           color: white; display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: white;">
                        <i class="fas fa-truck" style="margin-right: 12px;"></i>Lead Profile: \${lead.name || 'Unknown'}
                    </h2>
                    <button onclick="document.getElementById('lead-profile-container').remove()"
                            style="background: rgba(255,255,255,0.9); border: 2px solid white; color: #0066cc;
                                   font-size: 24px; font-weight: bold; cursor: pointer; padding: 0; width: 36px;
                                   height: 36px; border-radius: 6px;">Ã—</button>
                </div>
                <div style="padding: 30px; overflow-y: auto; flex: 1;">

                    <!-- Reach-out & Communication -->
                    <div style="background: #f9fafb; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #111827;">Reach-out & Communication</h3>
                        <textarea placeholder="Add notes about calls, emails, follow-ups..."
                                  style="width: 100%; height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;">\${lead.notes || ''}</textarea>
                    </div>

                    <!-- Company Information -->
                    <div style="background: #f9fafb; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #111827;">Company Information</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div><label style="display: block; font-weight: bold; margin-bottom: 5px;">Company Name:</label>
                                 <input type="text" value="\${lead.name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div>
                            <div><label style="display: block; font-weight: bold; margin-bottom: 5px;">Contact:</label>
                                 <input type="text" value="\${lead.contact || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div>
                            <div><label style="display: block; font-weight: bold; margin-bottom: 5px;">Phone:</label>
                                 <input type="text" value="\${lead.phone || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div>
                            <div><label style="display: block; font-weight: bold; margin-bottom: 5px;">Email:</label>
                                 <input type="text" value="\${lead.email || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div>
                        </div>
                    </div>

                    <!-- Loss Runs & Documentation -->
                    <div style="background: #f9fafb; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #111827;">Loss Runs & Documentation</h3>
                        <button onclick="alert('Loss Runs upload for: ' + '\${lead.name}')"
                                style="background: #3b82f6; color: white; border: none; padding: 12px 20px; border-radius: 6px; margin-right: 10px;">ðŸ“ Upload Loss Runs</button>
                        <button onclick="openEmailDocumentation && openEmailDocumentation('\${lead.id}')"
                                style="background: #16a34a; color: white; border: none; padding: 12px 20px; border-radius: 6px;">ðŸ“§ Email Documentation</button>
                    </div>

                    <!-- Call Transcription -->
                    <div style="background: #f9fafb; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #111827;">Call Transcription & Details</h3>
                        <textarea placeholder="Call transcription and details..."
                                  style="width: 100%; height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;">\${lead.transcriptText || ''}</textarea>
                    </div>

                    <!-- Vehicles -->
                    <div style="background: #f9fafb; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #111827;">Vehicles</h3>
                        <p style="color: #6b7280;">Vehicle information for \${lead.name}</p>
                    </div>

                </div>
            \`;

            modalContainer.appendChild(modalContent);
            document.body.appendChild(modalContainer);

            console.log('âœ… DIRECT: Enhanced profile modal created successfully');
        };

        // Create Email Documentation function
        window.openEmailDocumentation = function(leadId) {
            const leads = JSON.parse(localStorage.getItem('insurance_leads') || '[]');
            const lead = leads.find(l => String(l.id) === String(leadId));
            if (lead) {
                const subject = \`Insurance Quote Documentation Request - \${lead.name} \${lead.renewalDate ? '(Exp: ' + lead.renewalDate + ')' : '(Exp: TBD)'}\`;
                alert(\`Email Documentation:\\nTo: \${lead.email || 'No email'}\\nSubject: \${subject}\`);
            }
        };

        console.log('âœ… DIRECT: Enhanced profile functions created successfully');
        console.log('âœ… DIRECT: createEnhancedProfile available:', typeof window.createEnhancedProfile);

        // Force override viewLead function
        window.viewLead = function(leadId) {
            console.log('ðŸ”¥ DIRECT: viewLead called for:', leadId);

            // Get lead data
            const leads = JSON.parse(localStorage.getItem('insurance_leads') || '[]');
            const lead = leads.find(l => String(l.id) === String(leadId));

            if (lead && window.createEnhancedProfile) {
                console.log('ðŸ”¥ DIRECT: Opening enhanced profile for:', lead.name);
                window.createEnhancedProfile(lead);
            } else if (lead) {
                console.error('ðŸ”¥ DIRECT: createEnhancedProfile not available');
                console.log('ðŸ”¥ DIRECT: Available functions:', Object.keys(window).filter(k => k.includes('Lead') || k.includes('Profile')));
            } else {
                console.error('ðŸ”¥ DIRECT: Lead not found for ID:', leadId);
            }

            return false;
        };

        console.log('âœ… DIRECT: viewLead override complete');
    </script>

    <!-- DEBUG SCRIPTS DISABLED - They are intercepting viewLead -->
    <!-- <script src="js/debug-lead-not-found.js?v=1"></script> DISABLED - Intercepting viewLead -->
    <!-- <script src="js/fix-lead-creation-complete.js?v=1"></script> DISABLED - Intercepting viewLead -->
    <!-- <script src="js/fix-lead-not-found.js"></script> DISABLED - Intercepting viewLead -->
    <!-- <script src="js/debug-lead-storage.js"></script> DISABLED - Intercepting viewLead -->
    <!-- <script src="js/fix-quote-application-button.js"></script> DISABLED - Intercepting viewLead -->
    <!-- <script src="js/nuclear-highlighting-fix.js?v=6"></script> DISABLED - Intercepting viewLead -->

    <!-- Working profile with reach-out and loss runs sections -->
    <!-- <script src="js/working-profile-fix.js"></script> DISABLED - Using exact original -->

    <!-- Simple auto-save that doesn't interfere with typing -->
    <!-- <script src="js/simple-profile-autosave.js"></script> DISABLED - May interfere with modal -->

    <!-- Restore original lead profile UI -->
    <!-- <script src="js/restore-original-lead-profile.js"></script> DISABLED - Conflicts with protected version -->

    <!-- Profile enhancements DISABLED - causing conflicts with original profile -->
    <!-- <script src="js/fix-profile-display.js"></script> DISABLED - Conflicts with protected version -->
    <!-- <script src="js/add-assigned-to-dropdown.js?v=2"></script> -->

    <!-- Direct profile fix - ensures profile opens regardless of conflicts - DISABLED: Restoring original system -->
    <!-- <script src="js/direct-profile-fix.js"></script> -->

    <!-- Lead Stage Timestamp Feature - DISABLED - Moved to lead profile
    <script src="js/lead-stage-timestamp.js?v=10"></script> -->

    <script src="js/transcription-progress.js?v=1760730555"></script>

    <!-- FINAL FIX - Must load absolutely last to override everything -->
    <!-- <script src="js/fix-lead-table-final.js?v=7"></script> DISABLED - Causing blinking conflicts -->

    <!-- Timestamp highlighting fixes -->
    <!-- Disabled old attempts
    <script src="js/ultimate-timestamp-fix.js"></script>
    <script src="js/diagnose-timestamp-problem.js"></script>
    <script src="js/create-test-timestamps.js"></script>
    <script src="js/force-color-no-matter-what.js"></script>
    <script src="js/manual-color-override.js"></script>
    -->

    <!-- THE REAL FIX - This one actually works -->
    <!-- OLD: <script src="js/automatic-timestamp-colors.js"></script>
    <script src="js/fix-missing-highlights.js"></script> -->

    <!-- SYNCHRONIZED FIX - Uses exact same logic as profile -->
    <script src="js/synchronized-timestamp-colors.js"></script>
    <script src="js/final-debug-timestamps.js"></script>
    <script src="js/fix-year-2025-timestamps.js"></script>

    <!-- Disable all loading overlays - MUST BE LAST to override all other scripts -->
    <script src="js/disable-loading-overlays.js"></script>
    <!-- Live Debug Script for 162.220.14.239 -->
    <script src="js/live-debug-dulling.js?v=1"></script>
    <script src="js/force-freeze-timestamps.js"></script>
    <script src="js/force-quote-modal-front.js"></script>
    <script src="js/enhanced-quote-form.js"></script>
    <script src="js/enhanced-quote-modal.js?v=11"></script>

    <!-- Independent Agent Tracking System - Load Early -->
    <script src="js/independent-agent-tracking.js"></script>
    <script src="js/independent-enhanced-modal.js"></script>

    <!-- TEMPORARY DEBUG SCRIPT -->
    <script src="js/debug-lead-ids.js"></script>

    <!-- FORCE SIMPLE COUNTER SYSTEM -->
    <script>
        // Block ALL modal systems immediately
        window.FORCE_SIMPLE_COUNTER = true;

        // Immediate simple modal function
        window.showSimpleCounter = function(agentName) {
            console.log('ðŸŽ¯ [EMERGENCY SIMPLE] Creating basic counter for:', agentName);

            // Remove any existing modals
            document.querySelectorAll('.simple-counter-modal, .modal-overlay').forEach(el => el.remove());

            const modal = document.createElement('div');
            modal.className = 'simple-counter-modal';
            modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white !important;border-radius:12px !important;max-width:1000px !important;width:95% !important;max-height:90vh !important;overflow-y:auto !important;box-shadow:rgba(0,0,0,0.3) 0px 20px 40px !important;z-index:999999;animation:0.3s ease-out 0s 1 normal none running modalSlideIn !important;';

            // Get current counter values - CONSOLE-BASED STATS INTEGRATION with period awareness
            let counters = { leadCount: 0, callCount: 0, saleCount: 0, resetTimestamp: null };

            if (window.getAgentCounters) {
                // Check if we have an active time filter and use period-aware counters
                const activeButton = document.querySelector('.time-filter-buttons button[style*="rgb(37, 99, 235)"]');
                if (activeButton && window.getAgentCountersForPeriod) {
                    const filterText = activeButton.textContent.trim();
                    const periodMap = {
                        'Today': 'day', 'This Week': 'week', 'This Month': 'month',
                        'Year to Date': 'ytd', 'Custom Range': 'custom'
                    };
                    const period = periodMap[filterText];
                    if (period) {
                        counters = window.getAgentCountersForPeriod(agentName, period);
                        console.log(`ðŸŽ¯ MODAL-OVERRIDE: Using period-filtered counters for ${agentName} (${filterText}):`, counters);
                    } else {
                        counters = window.getAgentCounters(agentName);
                    }
                } else {
                    // DEFAULT: Use Today filter when no active button (modal creation before filters load)
                    if (window.getAgentCountersForPeriod) {
                        counters = window.getAgentCountersForPeriod(agentName, 'day');
                        console.log(`ðŸŽ¯ MODAL-OVERRIDE: Using default TODAY counters for ${agentName} (no active button yet):`, counters);
                    } else {
                        counters = window.getAgentCounters(agentName);
                        console.log(`ðŸŽ¯ MODAL-OVERRIDE: Using fallback overall counters for ${agentName}:`, counters);
                    }
                }
            }

            // The counters already include call duration from getAgentCounters - no override needed!
            // getAgentCounters now includes totalCallDuration from console message tracking
            console.log(`ðŸŽ¯ MODAL-OVERRIDE: Using TRUE incremental counters for ${agentName}:`, counters);
            console.log(`ðŸ”§ MODAL-OVERRIDE: Calls: ${counters.callCount}, Duration: ${counters.totalCallDuration} from TRUE counter system`);

            // Get lead data for additional analysis
            const leads = JSON.parse(localStorage.getItem('insurance_leads') || '[]');
            const agentLeads = leads.filter(lead => lead.assignedTo === agentName);

            // Calculate additional metrics
            let totalCallTime = 0;
            let highValueLeads = 0;
            let lowValueLeads = 0;
            let contactedLeads = 0;

            agentLeads.forEach(lead => {
                // Call time calculation
                if (lead.callLogs) {
                    lead.callLogs.forEach(call => {
                        totalCallTime += call.duration || 0;
                    });
                }
                if (lead.reachOut && lead.reachOut.callLogs) {
                    lead.reachOut.callLogs.forEach(call => {
                        totalCallTime += call.duration || 0;
                    });
                }

                // High/Low value classification
                const premium = parseFloat(lead.premium || 0);
                if (premium > 5000) {
                    highValueLeads++;
                } else if (premium < 1000) {
                    lowValueLeads++;
                }

                // Contact tracking
                if (lead.reachOut && lead.reachOut.contacted) {
                    contactedLeads++;
                }
            });

            const contactRate = agentLeads.length > 0 ? (contactedLeads / agentLeads.length * 100).toFixed(1) : '0.0';
            const conversionRate = counters.leadCount > 0 ? (counters.saleCount / counters.leadCount * 100).toFixed(1) : '0.0';

            // USE TRUE COUNTER SYSTEM CALL DURATION
            let finalCallDuration = counters.totalCallDuration * 60; // Convert TRUE counter minutes to seconds for consistency
            if (finalCallDuration === 0) {
                finalCallDuration = totalCallTime; // Fallback to calculated if no TRUE data
            }
            console.log(`ðŸŽ¯ MODAL-OVERRIDE: Using TRUE counter call duration: ${counters.totalCallDuration} minutes`);
            const avgCallTime = counters.callCount > 0 ? (finalCallDuration / counters.callCount / 60).toFixed(1) : '0';

            // Calculate averages (mock data for now)
            const avgStats = {
                totalLeads: 29,
                highValueLeads: 12,
                lowValueLeads: 58.6,
                totalCalls: 45,
                callDuration: 382.5,
                contactRate: 93.1,
                leadsToBrokers: 7,
                nonGreenTime: 18.2
            };

            // Calculate vs average differences
            const vsAvg = {
                totalLeads: counters.leadCount - avgStats.totalLeads,
                highValueLeads: highValueLeads - avgStats.highValueLeads,
                lowValueLeads: (agentLeads.length > 0 ? ((lowValueLeads / agentLeads.length) * 100) : 0) - avgStats.lowValueLeads,
                totalCalls: counters.callCount - avgStats.totalCalls,
                callDuration: counters.totalCallDuration - avgStats.callDuration,
                contactRate: parseFloat(contactRate) - avgStats.contactRate,
                leadsToBrokers: counters.leadsToBrokers - avgStats.leadsToBrokers,
                nonGreenTime: 0 - avgStats.nonGreenTime
            };

            // Helper function to get card style based on performance
            const getCardStyle = (value, isGood = false) => {
                if (value === 0) {
                    return 'background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;';
                }
                return isGood ?
                    'background: #f0fdf4; border: 1px solid #bbf7d0; color: #059669;' :
                    'background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;';
            };

            modal.innerHTML = `
                <!-- Header -->
                <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0; color: #1f2937; font-size: 24px; font-weight: 600;">
                            <i class="fas fa-user-circle" style="margin-right: 12px; color: #3b82f6;"></i>${agentName} Performance Profile (Today)
                        </h2>
                        <button onclick="this.closest('.simple-counter-modal').remove()" style="
                            background: none;
                            border: none;
                            font-size: 28px;
                            cursor: pointer;
                            color: #6b7280;
                            padding: 4px;
                            line-height: 1;
                        ">Ã—</button>
                    </div>
                    <div class="time-filter-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <!-- Time period filters -->
                        <button id="filter-day" onclick="applyTimeFilter('${agentName}', 'day')" style="padding: 8px 16px; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Today</button>
                        <button id="filter-week" onclick="applyTimeFilter('${agentName}', 'week')" style="padding: 8px 16px; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">This Week</button>
                        <button id="filter-month" onclick="applyTimeFilter('${agentName}', 'month')" style="padding: 8px 16px; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">This Month</button>
                        <button id="filter-ytd" onclick="applyTimeFilter('${agentName}', 'ytd')" style="padding: 8px 16px; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Year to Date</button>
                        <button id="filter-custom" onclick="applyTimeFilter('${agentName}', 'custom')" style="padding: 8px 16px; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Custom Range</button>

                        <!-- Smart Reset Button -->
                        <button onclick="handleSmartReset('${agentName}')" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;"><i class="fas fa-redo"></i> Reset</button>
                    </div>
                </div>

                <!-- Content -->
                <div style="padding: 24px; color: #1f2937 !important;">

                    <!-- Lead Distribution Group -->
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px; font-weight: 600;">Lead Distribution</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">

                            <div style="text-align: center; padding: 20px; ${getCardStyle(counters.leadCount)} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">${counters.leadCount}</div>
                                <div style="font-size: 14px;">Total Leads</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.totalLeads > 0 ? '+' : ''}${vsAvg.totalLeads.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.totalLeads}</div>
                            </div>

                            <div style="text-align: center; padding: 20px; ${getCardStyle(highValueLeads)} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">${highValueLeads}</div>
                                <div style="font-size: 14px;">High Value Leads</div>
                                <div style="font-size: 12px; margin-top: 4px;">${agentLeads.length > 0 ? ((highValueLeads / agentLeads.length) * 100).toFixed(1) : '0'}% of total</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.highValueLeads > 0 ? '+' : ''}${vsAvg.highValueLeads.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.highValueLeads}</div>
                            </div>

                            <div style="text-align: center; padding: 20px; ${getCardStyle(lowValueLeads, true)} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">${agentLeads.length > 0 ? ((lowValueLeads / agentLeads.length) * 100).toFixed(1) : '0'}%</div>
                                <div style="font-size: 14px;">Low Value Leads</div>
                                <div style="font-size: 12px; margin-top: 4px;">${lowValueLeads} total leads</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.lowValueLeads > 0 ? '+' : ''}${vsAvg.lowValueLeads.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.lowValueLeads}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Call Activity Group -->
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px; font-weight: 600;">Call Activity</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">

                            <div style="text-align: center; padding: 20px; ${getCardStyle(counters.callCount)} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">${counters.callCount}</div>
                                <div style="font-size: 14px;">Total Calls</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.totalCalls > 0 ? '+' : ''}${vsAvg.totalCalls.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.totalCalls}</div>
                            </div>

                            <div style="text-align: center; padding: 20px; ${getCardStyle(finalCallDuration)} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">${counters.totalCallDuration}</div>
                                <div style="font-size: 14px;">Total Call Duration (min)</div>
                                <div style="font-size: 12px; margin-top: 4px;">Avg: ${avgCallTime} min/call</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.callDuration > 0 ? '+' : ''}${vsAvg.callDuration.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.callDuration}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Metrics -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px; font-weight: 600;">Performance Metrics</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">

                            <div style="text-align: center; padding: 20px; ${getCardStyle(parseFloat(contactRate))} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">${contactRate}%</div>
                                <div style="font-size: 14px;">Contact Rate</div>
                                <div style="font-size: 12px; margin-top: 4px;">%</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.contactRate > 0 ? '+' : ''}${vsAvg.contactRate.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.contactRate}%</div>
                            </div>

                            <div style="text-align: center; padding: 20px; ${getCardStyle(counters.leadsToBrokers)} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">${counters.leadsToBrokers}</div>
                                <div style="font-size: 14px;">Leads to Brokers</div>
                                <div style="font-size: 12px; margin-top: 4px;">${counters.leadCount > 0 ? ((counters.leadsToBrokers / counters.leadCount) * 100).toFixed(1) : (counters.leadsToBrokers > 0 ? '100' : '0')}% of total</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.leadsToBrokers > 0 ? '+' : ''}${vsAvg.leadsToBrokers.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.leadsToBrokers}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Areas for Improvement -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px; font-weight: 600;">Areas for Improvement</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">

                            <div style="text-align: center; padding: 20px; ${getCardStyle(0)} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">0</div>
                                <div style="font-size: 14px;">Time on Non-Green Leads</div>
                                <div style="font-size: 12px; margin-top: 4px;">Time spent on low-priority leads</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.nonGreenTime > 0 ? '+' : ''}${vsAvg.nonGreenTime.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.nonGreenTime}</div>
                            </div>

                            <div style="text-align: center; padding: 20px; ${getCardStyle(lowValueLeads, true)} border-radius: 12px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">${agentLeads.length > 0 ? ((lowValueLeads / agentLeads.length) * 100).toFixed(1) : '0'}%</div>
                                <div style="font-size: 14px;">Low Value Lead Rate</div>
                                <div style="font-size: 12px; margin-top: 4px;">Percentage of leads with low potential</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">${vsAvg.lowValueLeads > 0 ? '+' : ''}${vsAvg.lowValueLeads.toFixed(1)} vs avg</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">Avg: ${avgStats.lowValueLeads}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Summary -->
                    <div style="margin-top: 24px; padding: 20px; background: #f8fafc; border-radius: 12px; border-left: 4px solid #3b82f6;">
                        <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 18px;">Performance Summary</h3>
                        <p style="margin: 0; color: #4b5563; line-height: 1.6;">
                            ${agentName} has managed <strong>${counters.leadCount} total leads since reset</strong> with
                            <strong style="color: #059669;">${highValueLeads} high-value leads</strong> (${agentLeads.length > 0 ? ((highValueLeads / agentLeads.length) * 100).toFixed(1) : '0'}%) and
                            <strong style="color: #dc2626;">${lowValueLeads} low-value leads</strong> (${agentLeads.length > 0 ? ((lowValueLeads / agentLeads.length) * 100).toFixed(1) : '0'}%).
                            Contact rate: <strong>${contactRate}%</strong>.
                            0 leads were referred to brokers (0%).
                            ${counters.resetTimestamp ? `<br><br><em style="opacity:0.7;">ðŸ“… Counter reset on: ${new Date(counters.resetTimestamp).toLocaleDateString()}</em>` : ''}
                        </p>
                    </div>
                </div>

                <!-- Bottom Action Section -->
                <div style="padding: 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <!-- Action Buttons Left Side -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="
                            if(window.incrementLeadCounter) window.incrementLeadCounter('${agentName}');
                            window.showSimpleCounter('${agentName}');
                        " style="background: #16a34a; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;">+1 Lead</button>

                        <button onclick="
                            if(window.incrementCallCounter) window.incrementCallCounter('${agentName}');
                            window.showSimpleCounter('${agentName}');
                        " style="background: #3b82f6; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;">+1 Call</button>

                        <button onclick="
                            if(window.incrementSaleCounter) window.incrementSaleCounter('${agentName}');
                            window.showSimpleCounter('${agentName}');
                        " style="background: #8b5cf6; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;">+1 Sale</button>
                    </div>

                    <!-- Download/Close Buttons Right Side -->
                    <div style="text-align: right;">
                        <button onclick="alert('PDF download - Coming soon!')" style="
                            padding: 12px 24px;
                            background: #059669;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 500;
                            margin-right: 12px;
                        ">
                            <i class="fas fa-file-pdf" style="margin-right: 8px;"></i>Download PDF Report
                        </button>
                        <button onclick="this.closest('.simple-counter-modal').remove()" style="
                            padding: 12px 24px;
                            background: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 500;
                        ">Close Profile</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            console.log('âœ… Emergency simple modal created');

            // Automatically apply "Today" filter as default
            setTimeout(() => {
                if (window.applyTimeFilter) {
                    console.log('ðŸ•’ AUTO-APPLYING: Setting Today as default filter');
                    window.applyTimeFilter(agentName, 'day');
                }
            }, 100);
        };

        // Override everything immediately
        window.viewAgentStats = function(agentName) {
            console.log('ðŸŽ¯ [IMMEDIATE BLOCK] Using emergency simple counter');
            return window.showSimpleCounter(agentName);
        };

        window.enhancedViewAgentStats = function(agentName) {
            console.log('ðŸŽ¯ [IMMEDIATE BLOCK] Enhanced blocked, using simple counter');
            return window.showSimpleCounter(agentName);
        };

        // Time Period Filter Function for Agent Performance Reports
        window.applyTimeFilter = function(agentName, period) {
            console.log(`ðŸ•’ Applying time filter: ${period} for agent: ${agentName}`);

            // SPECIAL CASE: Only "since-reset" actually resets the counters
            if (period === 'since-reset') {
                console.log('ðŸ”„ RESET: Reset Counters button clicked - resetting counters');

                // Determine current active filter and corresponding period
                let currentFilter = 'Today'; // Default
                let currentPeriod = 'day'; // Default
                const activeButton = document.querySelector('.time-filter-buttons button[style*="rgb(37, 99, 235)"]');
                if (activeButton) {
                    currentFilter = activeButton.textContent.trim();
                    // Map display names to period codes
                    const periodMap = {
                        'Today': 'day',
                        'This Week': 'week',
                        'This Month': 'month',
                        'Year to Date': 'ytd',
                        'Custom Range': 'custom'
                    };
                    currentPeriod = periodMap[currentFilter] || 'day';

                    // Remove emoji if present
                    if (currentFilter.includes('ðŸ”„')) {
                        currentFilter = 'All Counters';
                        currentPeriod = 'all';
                    }
                }

                console.log(`ðŸ” DEBUG: Checking reset function availability - resetAgentCounterForPeriod: ${typeof window.resetAgentCounterForPeriod}, currentPeriod: ${currentPeriod}`);

                if (window.resetAgentCounterForPeriod && currentPeriod !== 'all') {
                    console.log(`ðŸŽ¯ Using period-specific reset for ${currentPeriod}`);
                    const confirmReset = confirm(`Reset the ${currentFilter} counter for ${agentName} back to 0?\n\nThis will mark ${currentFilter} as reset and show filtered data from that point forward.`);
                    if (confirmReset) {
                        console.log(`ðŸ”¢ PERIOD RESET: Calling resetAgentCounterForPeriod('${agentName}', '${currentPeriod}')`);
                        window.resetAgentCounterForPeriod(agentName, currentPeriod);

                        // Refresh the modal to show period-filtered reset values (0s)
                        setTimeout(() => {
                            console.log(`ðŸ”„ RESET-REFRESH: Refreshing modal after period reset for ${agentName} (${currentFilter})`);

                            // Get the period-filtered counters (should be 0 since we just reset)
                            const resetCounters = window.getAgentCountersForPeriod ?
                                window.getAgentCountersForPeriod(agentName, currentPeriod) :
                                { leadCount: 0, callCount: 0, saleCount: 0, leadsToBrokers: 0, totalCallDuration: 0 };

                            console.log(`ðŸ”„ RESET-REFRESH: Post-reset counters for ${currentPeriod}:`, resetCounters);

                            const modal = document.getElementById('agent-profile-modal') ||
                                         document.querySelector('.simple-counter-modal') ||
                                         document.querySelector('[class*="modal"]');

                            if (modal) {
                                console.log(`ðŸ”„ RESET-REFRESH: Found modal, updating metrics to show reset values`);

                                // Find and update all metric values
                                const metricElements = modal.querySelectorAll('[style*="font-size: 28px"], [style*="font-size:28px"]');
                                console.log(`ðŸ”„ RESET-REFRESH: Found ${metricElements.length} metric elements to update`);

                                metricElements.forEach((element, index) => {
                                    const nextElement = element.nextElementSibling;
                                    const parentElement = element.parentElement;

                                    if (nextElement && nextElement.textContent) {
                                        const labelText = nextElement.textContent.trim();
                                        console.log(`ðŸ”„ RESET-REFRESH: Processing metric ${index + 1}: "${labelText}"`);

                                        let newValue = 0;
                                        let newColor = '#dc2626'; // Red for 0 values

                                        // Update based on label text
                                        if (labelText.includes('Total Leads')) {
                                            newValue = resetCounters.leadCount;
                                            newColor = resetCounters.leadCount > 0 ? '#059669' : '#dc2626';
                                        } else if (labelText.includes('Total Calls')) {
                                            newValue = resetCounters.callCount;
                                            newColor = resetCounters.callCount > 0 ? '#059669' : '#dc2626';
                                        } else if (labelText.includes('Sales')) {
                                            newValue = resetCounters.saleCount;
                                            newColor = resetCounters.saleCount > 0 ? '#059669' : '#dc2626';
                                        } else if (labelText.includes('Leads to Brokers')) {
                                            newValue = resetCounters.leadsToBrokers || 0;
                                            newColor = (resetCounters.leadsToBrokers || 0) > 0 ? '#10b981' : '#dc2626';
                                        } else if (labelText.includes('Total Call Duration')) {
                                            newValue = resetCounters.totalCallDuration || 0;
                                            newColor = (resetCounters.totalCallDuration || 0) > 0 ? '#0ea5e9' : '#dc2626';
                                        }

                                        console.log(`ðŸ”„ RESET-REFRESH: Updating "${labelText}" from ${element.textContent} to ${newValue}`);
                                        element.textContent = newValue;
                                        element.style.color = newColor;
                                        element.style.fontWeight = 'bold';

                                        // Flash green to show update
                                        element.style.background = '#10b981';
                                        element.style.color = 'white';
                                        setTimeout(() => {
                                            element.style.background = '';
                                            element.style.color = newColor;
                                        }, 300);
                                    }
                                });

                                console.log(`âœ… RESET-REFRESH: Modal updated with reset values for ${agentName} (${currentFilter})`);
                            } else {
                                console.log(`âŒ RESET-REFRESH: No modal found to update`);
                            }
                        }, 200);

                        alert(`âœ… ${currentFilter} counter reset for ${agentName}!`);
                        console.log(`ðŸ”¢ Period-specific reset applied: ${currentPeriod} for ${agentName}`);
                        return;
                    } else {
                        // User cancelled reset, don't change anything
                        console.log('âŒ Reset cancelled by user');
                        return;
                    }
                } else if (window.resetAgentCounter) {
                    console.log(`âš ï¸ FALLBACK: Using full reset - resetAgentCounterForPeriod not available or currentPeriod is 'all'`);
                    const confirmReset = confirm(`Reset ALL counters for ${agentName} back to 0?\n\nThis will reset all time periods.`);
                    if (confirmReset) {
                        console.log(`ðŸ”¢ FULL RESET: Calling resetAgentCounter('${agentName}')`);
                        window.resetAgentCounter(agentName);
                        // Refresh the modal to show reset values
                        setTimeout(() => {
                            if (window.showTrueCounterModal) {
                                window.showTrueCounterModal(agentName);
                            }
                        }, 500);
                        alert(`âœ… All counters reset to 0 for ${agentName}!`);
                        return;
                    } else {
                        // User cancelled reset, don't change anything
                        console.log('âŒ Reset cancelled by user');
                        return;
                    }
                }
                return; // Exit early for reset action
            }

            // For all other filters: just update the view, don't reset data
            updateFilterButtonStates(period);

            // Get the current counters with period filtering support
            let counters = { leadCount: 0, callCount: 0, saleCount: 0, leadsToBrokers: 0, totalCallDuration: 0 };
            if (window.getAgentCounters) {
                // Use period-aware counters if available and period is specified
                if (window.getAgentCountersForPeriod && ['day', 'week', 'month', 'ytd', 'custom'].includes(period)) {
                    counters = window.getAgentCountersForPeriod(agentName, period);
                    console.log(`ðŸŽ¯ FILTER-OVERRIDE: Using period-filtered counters for ${agentName} (${period}):`, counters);
                } else {
                    counters = window.getAgentCounters(agentName);
                }
            }

            // For now, show the current counters with a note about the time period
            // In the future, this could filter based on actual timestamps
            let periodLabel = '';
            let filteredData = { ...counters };

            switch(period) {
                case 'since-reset':
                    periodLabel = 'Since Reset';
                    // This is the default - show all data since last reset
                    break;
                case 'day':
                    periodLabel = 'Today';
                    // For now, show current data (could be filtered by date in future)
                    break;
                case 'week':
                    periodLabel = 'This Week';
                    // For now, show current data (could be filtered by date in future)
                    break;
                case 'month':
                    periodLabel = 'This Month';
                    // For now, show current data (could be filtered by date in future)
                    break;
                case 'ytd':
                    periodLabel = 'Year to Date';
                    // For now, show current data (could be filtered by date in future)
                    break;
                case 'custom':
                    // Show date picker for custom range
                    const startDate = prompt('Enter start date (YYYY-MM-DD):');
                    const endDate = prompt('Enter end date (YYYY-MM-DD):');
                    if (startDate && endDate) {
                        periodLabel = `${startDate} to ${endDate}`;
                    } else {
                        return; // Cancel if no dates provided
                    }
                    break;
            }

            // Update the modal title to show the time period
            const titleElement = document.querySelector('.simple-counter-modal h2');
            if (titleElement) {
                titleElement.innerHTML = `
                    <i class="fas fa-user-circle" style="margin-right: 12px; color: #3b82f6;"></i>
                    ${agentName} Performance Profile (${periodLabel})
                `;
                console.log(`ðŸ”„ TITLE-UPDATE: Updated header to show ${periodLabel}`);
            } else {
                console.log(`ðŸ”„ TITLE-UPDATE: Header element not found`);
            }

            // Show a notification about the filter
            if (period !== 'since-reset') {
                // For now, show a note that this will be enhanced with historical data
                const notification = document.createElement('div');
                notification.style.cssText = `
                    background: #e0f2fe;
                    border: 1px solid #0288d1;
                    color: #01579b;
                    padding: 12px;
                    border-radius: 8px;
                    margin: 16px;
                    font-size: 14px;
                    text-align: center;
                `;
                notification.innerHTML = `
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    <strong>${periodLabel} View Active</strong><br>
                    Currently showing latest data. Historical filtering will be enhanced in future updates.
                `;

                // Find a good place to insert the notification
                const modal = document.getElementById('agent-profile-modal');
                const statsContainer = modal?.querySelector('.simple-counter-stats');
                if (statsContainer && statsContainer.parentNode) {
                    // Remove any existing notifications
                    const existingNotification = modal.querySelector('[data-time-filter-notification]');
                    if (existingNotification) {
                        existingNotification.remove();
                    }

                    notification.setAttribute('data-time-filter-notification', 'true');
                    statsContainer.parentNode.insertBefore(notification, statsContainer);
                }
            } else {
                // Remove notification for "Since Reset" view
                const modal = document.getElementById('agent-profile-modal');
                const existingNotification = modal?.querySelector('[data-time-filter-notification]');
                if (existingNotification) {
                    existingNotification.remove();
                }
            }

            // Refresh the modal to show period-filtered values
            setTimeout(() => {
                const modal = document.querySelector('.simple-counter-modal');
                if (modal) {
                    console.log(`ðŸ”„ MODAL-REFRESH: Refreshing modal for ${agentName} with ${periodLabel} filter`);
                    console.log(`ðŸ”„ MODAL-REFRESH: Should update to show ${counters.callCount} calls`);

                    // Find and update the metric values using the period-aware counters
                    const metricElements = modal.querySelectorAll('[style*="font-size: 28px"], [style*="font-size:28px"]');
                    console.log(`ðŸ”„ MODAL-REFRESH: Found ${metricElements.length} metric elements`);

                    metricElements.forEach(element => {
                        const nextElement = element.nextElementSibling;
                        const parentElement = element.parentElement;

                        // The label comes AFTER the number in this HTML structure
                        if (nextElement && nextElement.textContent) {
                            const labelText = nextElement.textContent.trim();
                            console.log(`ðŸ”§ MODAL-UPDATE: Checking element with label "${labelText}" and current value "${element.textContent}"`);

                            // Update the values based on the label
                            if (labelText.includes('Total Leads')) {
                                console.log(`ðŸ”§ MODAL-UPDATE: Updating Total Leads from ${element.textContent} to ${counters.leadCount}`);
                                element.textContent = counters.leadCount;
                                // Keep red color for stats that are below average
                                element.style.color = '#dc2626';
                            } else if (labelText.includes('Total Calls')) {
                                console.log(`ðŸ”§ MODAL-UPDATE: Updating Total Calls from ${element.textContent} to ${counters.callCount}`);
                                element.textContent = counters.callCount;
                                // Keep red color for stats that are below average
                                element.style.color = '#dc2626';
                            } else if (labelText.includes('Sales')) {
                                element.textContent = counters.saleCount;
                                element.style.color = counters.saleCount > 0 ? '#059669' : '#dc2626';
                            } else if (labelText.includes('Leads to Brokers')) {
                                element.textContent = counters.leadsToBrokers || 0;
                                element.style.color = (counters.leadsToBrokers || 0) > 0 ? '#10b981' : '#dc2626';
                            } else if (labelText.includes('Total Call Duration')) {
                                console.log(`ðŸ”§ MODAL-UPDATE: Updating Total Call Duration from ${element.textContent} to ${counters.totalCallDuration || 0}`);
                                element.textContent = counters.totalCallDuration || 0;
                                // Keep red color for stats that are below average
                                element.style.color = '#dc2626';
                            } else if (labelText.includes('High Value Leads')) {
                                console.log(`ðŸ”§ MODAL-UPDATE: Updating High Value Leads from ${element.textContent} to ${counters.highValueLeads || 0}`);
                                element.textContent = counters.highValueLeads || 0;
                                // Keep red color for stats that are below average
                                element.style.color = '#dc2626';
                            }
                        }
                    });

                    console.log(`âœ… MODAL-REFRESH: Updated modal metrics for ${agentName} (${periodLabel})`);
                }
            }, 100);

            console.log(`âœ… Applied ${periodLabel} filter for ${agentName}`);
        };

        // Smart Reset Handler - Detects current filter and resets accordingly
        window.handleSmartReset = function(agentName) {
            console.log(`ðŸŽ¯ SMART RESET: Handling reset for ${agentName}`);

            // Detect which filter is currently active
            const activeButton = document.querySelector('.time-filter-buttons button[style*="rgb(37, 99, 235)"]');
            let activeFilter = 'All';
            let activePeriod = 'all';

            if (activeButton) {
                activeFilter = activeButton.textContent.trim();
                console.log('ðŸŽ¯ ACTIVE FILTER DETECTED:', activeFilter);

                // Map display names to period codes
                const filterToPeriod = {
                    'Today': 'day',
                    'This Week': 'week',
                    'This Month': 'month',
                    'Year to Date': 'ytd',
                    'Custom Range': 'custom'
                };
                activePeriod = filterToPeriod[activeFilter] || 'all';
                console.log('ðŸŽ¯ MAPPED PERIOD:', activePeriod);
            } else {
                console.log('âš ï¸ NO ACTIVE FILTER: Using full reset');
            }

            // Create appropriate confirmation message
            const resetMessage = activeFilter !== 'All' ?
                `Reset only the ${activeFilter} counter to 0? This will reset only ${activeFilter}, leaving other time periods unchanged.` :
                `Reset ALL counters to 0? This will reset all time periods.`;

            console.log('ðŸ’¬ RESET MESSAGE:', resetMessage);

            // Show confirmation dialog
            const confirmReset = confirm(resetMessage);
            if (!confirmReset) {
                console.log('âŒ Reset cancelled by user');
                return;
            }

            // Execute the appropriate reset
            if (activePeriod !== 'all' && window.resetAgentCounterForPeriod) {
                console.log(`ðŸ”„ ACTION: Calling resetAgentCounterForPeriod('${agentName}', '${activePeriod}')`);
                window.resetAgentCounterForPeriod(agentName, activePeriod);
                alert(`âœ… ${activeFilter} counter reset for ${agentName}!`);

                // Refresh modal after short delay
                setTimeout(() => {
                    window.showSimpleCounter(agentName);
                }, 300);
            } else if (window.resetAgentCounter) {
                console.log(`ðŸ”„ ACTION: Calling resetAgentCounter('${agentName}') - Full reset`);
                window.resetAgentCounter(agentName);
                alert(`âœ… All counters reset for ${agentName}!`);

                // Refresh modal after short delay
                setTimeout(() => {
                    window.showSimpleCounter(agentName);
                }, 300);
            } else {
                console.error('âŒ No reset function available!');
                alert('Error: Reset functionality not available');
            }
        };

        // Helper function to update filter button states
        function updateFilterButtonStates(activePeriod) {
            const buttons = document.querySelectorAll('.time-filter-buttons button');
            buttons.forEach(button => {
                const isActive = button.id === `filter-${activePeriod}`;
                const isResetButton = button.id === 'filter-since-reset';

                if (isActive) {
                    if (isResetButton) {
                        // Reset button stays red when active
                        button.style.background = '#dc2626';
                        button.style.color = 'white';
                    } else {
                        // Regular filter buttons turn blue when active
                        button.style.background = 'rgb(37, 99, 235)';
                        button.style.color = 'white';
                    }
                } else {
                    if (isResetButton) {
                        // Reset button uses red when inactive
                        button.style.background = '#ef4444';
                        button.style.color = 'white';
                    } else {
                        // Regular filter buttons are gray when inactive
                        button.style.background = '#f3f4f6';
                        button.style.color = '#374151';
                    }
                }
            });
        }
    </script>

    <!-- True Incremental Counter System - Load Last -->
    <script src="js/true-incremental-counter.js"></script>
    <script src="js/vicidial-import-listener.js"></script>
    <script src="js/simple-counter-modal.js"></script>

    <!-- Mobile Enhancements -->
    <script src="js/mobile-enhancements.js?v=1"></script>

    <!-- POLICY FIXES -->
    <script src="js/fix-policies-immediate-load.js"></script>

    <!-- CRITICAL: Harry Welling TODO Fix -->
    <script src="js/comprehensive-final-fix.js"></script>

    <!-- Mobile Navigation JavaScript -->
    <script>
        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const isActive = mobileNav.classList.contains('active');

            if (isActive) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        function openMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            const mobileOverlay = document.getElementById('mobileOverlay');

            mobileNav.classList.add('active');
            mobileOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            const mobileOverlay = document.getElementById('mobileOverlay');

            mobileNav.classList.remove('active');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Close mobile menu when resizing to desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });

        // Close mobile menu when pressing Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });

        // Mobile Renewal Tabs Functionality
        function initMobileRenewalTabs() {
            const tabs = document.querySelectorAll('.mobile-renewal-tab');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));

                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Get tab type
                    const tabType = this.getAttribute('data-tab');

                    // Add visual feedback
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);

                    // You can add specific functionality for personal vs agency view here
                    console.log('Switched renewal view to:', tabType);
                });
            });
        }

        // Initialize mobile renewal tabs when page loads
        document.addEventListener('DOMContentLoaded', initMobileRenewalTabs);

        // CRITICAL: Vehicle/Trailer Separation Interceptor for Policy Save
        // This fixes the issue where QuickFill saves trailers as vehicles instead of separating them

        // Function to separate vehicles and trailers
        window.separateVehiclesAndTrailers = function(policyData) {
            console.log('ðŸ”§ SEPARATING vehicles and trailers in policy data...');
            console.log('ðŸ” Input policy data:', JSON.stringify(policyData, null, 2));

            if (policyData && policyData.vehicles) {
                const actualVehicles = [];
                const foundTrailers = [];

                policyData.vehicles.forEach((vehicle, index) => {
                    const vehicleIdentifier = vehicle[''] || vehicle.model || vehicle.description || '';
                    console.log(`ðŸ” Processing item ${index + 1}: "${vehicleIdentifier}"`);

                    if (vehicleIdentifier.toLowerCase().includes('trailer')) {
                        foundTrailers.push(vehicle);
                        console.log('ðŸš› MOVED to trailers:', vehicleIdentifier);
                    } else {
                        actualVehicles.push(vehicle);
                        console.log('ðŸš— KEPT as vehicle:', vehicleIdentifier);
                    }
                });

                policyData.vehicles = actualVehicles;
                if (foundTrailers.length > 0) {
                    policyData.trailers = (policyData.trailers || []).concat(foundTrailers);
                    console.log('âœ… FIXED: Moved', foundTrailers.length, 'trailers to trailers array');
                }

                console.log('âœ… FINAL policy data structure:', {
                    vehicles: policyData.vehicles.length,
                    trailers: policyData.trailers?.length || 0,
                    vehicleDetails: policyData.vehicles,
                    trailerDetails: policyData.trailers
                });
            }

            return policyData;
        };

        // Multiple interceptor strategies

        // Strategy 1: Intercept savePolicy if it exists
        function installSavePolicyInterceptor() {
            if (typeof window.savePolicy === 'function' && !window.originalSavePolicy) {
                console.log('ðŸŽ¯ STRATEGY 1: Installing savePolicy interceptor...');
                window.originalSavePolicy = window.savePolicy;

                window.savePolicy = function(policyData, callback) {
                    console.log('ðŸ”§ INTERCEPTED savePolicy call!');
                    policyData = window.separateVehiclesAndTrailers(policyData);
                    return window.originalSavePolicy(policyData, callback);
                };

                console.log('âœ… savePolicy interceptor installed');
                return true;
            }
            return false;
        }

        // Strategy 2: Monitor for savePolicy function creation
        let savePolicyMonitor = setInterval(() => {
            if (installSavePolicyInterceptor()) {
                clearInterval(savePolicyMonitor);
            }
        }, 500);

        // Strategy 3: Intercept form data collection from DOM
        window.interceptFormData = function() {
            console.log('ðŸ”§ INTERCEPTING form data collection...');

            // Look for vehicle form data
            const vehicleForms = document.querySelectorAll('[id*="vehicle"], .vehicle-item, .form-section');
            const collectedData = { vehicles: [], trailers: [] };

            vehicleForms.forEach((form, index) => {
                const inputs = form.querySelectorAll('input, select, textarea');
                const vehicleData = {};

                inputs.forEach(input => {
                    if (input.value && input.value.trim()) {
                        vehicleData[input.id || input.name || 'field'] = input.value.trim();
                    }
                });

                // Check if this contains trailer data
                const hasTrailerData = Object.values(vehicleData).some(value =>
                    typeof value === 'string' && value.toLowerCase().includes('trailer')
                );

                if (hasTrailerData) {
                    collectedData.trailers.push({ ...vehicleData, vehicleNumber: index + 1 });
                    console.log('ðŸš› COLLECTED trailer data:', vehicleData);
                } else if (Object.keys(vehicleData).length > 0) {
                    collectedData.vehicles.push({ ...vehicleData, vehicleNumber: index + 1 });
                    console.log('ðŸš— COLLECTED vehicle data:', vehicleData);
                }
            });

            return collectedData;
        };

        // Strategy 4: Override localStorage.setItem to catch policy saves
        if (!window.originalLocalStorageSetItem) {
            window.originalLocalStorageSetItem = localStorage.setItem;

            localStorage.setItem = function(key, value) {
                if (key === 'policies' || key.includes('policy')) {
                    console.log('ðŸ”§ INTERCEPTED localStorage.setItem for policies!');
                    try {
                        let policies = JSON.parse(value);
                        if (Array.isArray(policies)) {
                            policies = policies.map(policy => window.separateVehiclesAndTrailers(policy));
                            value = JSON.stringify(policies);
                        } else if (policies && typeof policies === 'object') {
                            policies = window.separateVehiclesAndTrailers(policies);
                            value = JSON.stringify(policies);
                        }
                    } catch (e) {
                        console.log('Note: Could not parse policy data for separation');
                    }
                }
                return window.originalLocalStorageSetItem.call(this, key, value);
            };

            console.log('âœ… localStorage interceptor installed');
        }

        // Try initial install
        installSavePolicyInterceptor();

        console.log('âœ… Multi-strategy vehicle/trailer separation interceptors installed');
    </script>

    <!-- Call logs feature implemented -->

    <!-- COMPREHENSIVE TODO/HIGHLIGHTING FIX - Load last to override everything -->
    <script src="js/comprehensive-final-fix.js?v=3"></script>

    <!-- APP SENT STAGE INDEFINITE HIGHLIGHT FIX -->
    <script src="js/app-sent-highlight-fix.js?v=3"></script>

    <!-- DIRECT HIGHLIGHT BUTTON CLICK INTERCEPTOR -->
    <script src="js/highlight-button-interceptor.js?v=2"></script>

    <!-- APP SENT TODO OVERRIDE - Force empty TODO for app sent stage -->
    <script src="js/app-sent-todo-override.js?v=2"></script>

    <!-- FINAL APP SENT FIX - Ultimate override for all TODO generation -->
    <script src="js/final-app-sent-fix.js?v=2"></script>

    <!-- FIX FIRST TABLE TEMPLATE - Ensure first loading template works correctly -->
    <script src="js/fix-first-table-template.js?v=1"></script>

    <!-- VERIFICATION: Check if Harry Welling fix is working -->
    <script src="js/verify-harry-fix.js?v=1"></script>

    <!-- VERIFICATION: Check if app sent stage fix is working -->
    <script src="js/verify-app-sent-fix.js?v=1"></script>

    <!-- TEST: Verify empty TODO cells have green highlighting -->
    <script src="js/test-empty-todo-highlighting.js?v=1"></script>

    <!-- TEST: Verify email confirmation persistence after profile refresh -->
    <script src="js/test-email-confirmation-persistence.js?v=1"></script>

    <!-- DEBUG: Monitor email confirmation sequence in detail -->
    <script src="js/debug-email-confirmation-sequence.js?v=1"></script>

    <!-- PROTECT: Prevent email confirmations from being reset -->
    <script src="js/protect-email-confirmations.js?v=1"></script>

    <!-- VERIFY: Test that our scripts are actually loading and working -->
    <script src="js/verify-scripts-loading.js?v=1"></script>

    <!-- FINAL FIX: Complete email confirmation persistence solution -->
    <script src="js/final-email-confirmation-fix.js?v=1"></script>

    <!-- TEST: Comprehensive email confirmation fix verification -->
    <script src="js/test-email-confirmation-fix-complete.js?v=1"></script>

    <!-- REMOVED: Scripts moved earlier to ensure loading -->
</body>
</html>
